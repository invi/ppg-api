<!DOCTYPE html><html lang="en"><head><title>workers/gpg4browsers_worker</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="workers/gpg4browsers_worker"><meta name="groc-project-path" content="lib/workers/gpg4browsers_worker.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/workers/gpg4browsers_worker.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="cm">/**</span>
<span class="cm"> * create hexstring from a binary</span>
<span class="cm"> * @param str [String] string to convert</span>
<span class="cm"> * @return [String] string containing the hexadecimal values</span>
<span class="cm"> */</span>
<span class="k">this</span><span class="p">.</span><span class="nx">hexstrdump</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">str</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">r</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">h</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">c</span><span class="o">&lt;</span><span class="nx">e</span><span class="p">){</span>
        <span class="nx">h</span><span class="o">=</span><span class="nx">str</span><span class="p">[</span><span class="nx">c</span><span class="o">++</span><span class="p">].</span><span class="nx">charCodeAt</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="nx">h</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="o">+</span><span class="nx">h</span><span class="p">;</span>
        <span class="nx">r</span><span class="o">+=</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">h</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">_toHex</span><span class="p">(</span><span class="nx">rawHash</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">toHexString</span><span class="p">(</span><span class="nx">charCode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">charCode</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">hash</span> <span class="o">=</span> <span class="p">[</span><span class="nx">toHexString</span><span class="p">(</span><span class="nx">rawHash</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">rawHash</span><span class="p">)].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">hash</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">mpi</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mpi</span> <span class="o">=</span> <span class="nx">mpi</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">mpi_t</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toBigInteger</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> 
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">BigInteger</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mpi</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">bin2str</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bin</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bin</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">bin</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">str2bin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">getLeftNBits</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">bitcount</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rest</span> <span class="o">=</span> <span class="nx">bitcount</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">bitcount</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bitcount</span> <span class="o">-</span> <span class="nx">rest</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">shiftRight</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="mi">8</span><span class="o">-</span><span class="nx">rest</span><span class="p">);</span> <span class="c1">// +String.fromCharCode(string.charCodeAt(bytes -1) &lt;&lt; (8-rest) &amp; 0xFF);</span>
<span class="p">};</span>
<span class="cm">/**</span>
<span class="cm"> * Shifting a string to n bits right</span>
<span class="cm"> * @param value [String] the string to shift</span>
<span class="cm"> * @param bitcount [Integer] amount of bits to shift (MUST be smaller than 9)</span>
<span class="cm"> * @return [String] resulting string. </span>
<span class="cm"> */</span>
<span class="nx">shiftRight</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">bitcount</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">str2bin</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">bitcount</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">temp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="nx">bitcount</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">temp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="nx">temp</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="nx">bitcount</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">bin2str</span><span class="p">(</span><span class="nx">temp</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Basic JavaScript BN library - subset useful for RSA encryption.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bits per digit</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">dbits</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>JavaScript engine analysis</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">canary</span> <span class="o">=</span> <span class="mh">0xdeadbeefcafe</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">j_lm</span> <span class="o">=</span> <span class="p">((</span><span class="nx">canary</span><span class="o">&amp;</span><span class="mh">0xffffff</span><span class="p">)</span><span class="o">==</span><span class="mh">0xefcafe</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) Constructor</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">BigInteger</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">a</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="s2">&quot;number&quot;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">a</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fromNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;string&quot;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">a</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fromString</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">fromString</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return new, unset BigInteger</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">nbi</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">BigInteger</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>am: Compute w<em>j += (x*this</em>i), propagate carries,
c is initial carry, returns final carry.
c &lt; 3<em>dvalue, x &lt; 2</em>dvalue, this_i &lt; dvalue
We need to select the fastest one that works in this environment.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>am1: use a single mult and divide to get the high bits,
max digit bits should be 26 because
max internal value = 2<em>dvalue^2-2</em>dvalue (&lt; 2^53)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">am1</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">w</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">x</span><span class="o">*</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="o">+</span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">+</span><span class="nx">c</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">v</span><span class="o">/</span><span class="mh">0x4000000</span><span class="p">);</span>
    <span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="o">&amp;</span><span class="mh">0x3ffffff</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>am2 avoids a big mult-and-extract completely.
Max digit bits should be &lt;= 30 because we do bitwise ops
on values up to 2*hdvalue^2-hdvalue-1 (&lt; 2^31)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">am2</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">w</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">xl</span> <span class="o">=</span> <span class="nx">x</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">,</span> <span class="nx">xh</span> <span class="o">=</span> <span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">xh</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="nx">h</span><span class="o">*</span><span class="nx">xl</span><span class="p">;</span>
    <span class="nx">l</span> <span class="o">=</span> <span class="nx">xl</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="p">((</span><span class="nx">m</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="o">&amp;</span><span class="mh">0x3fffffff</span><span class="p">);</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">l</span><span class="o">&gt;&gt;&gt;</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">m</span><span class="o">&gt;&gt;&gt;</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span><span class="nx">xh</span><span class="o">*</span><span class="nx">h</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="o">&gt;&gt;&gt;</span><span class="mi">30</span><span class="p">);</span>
    <span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span><span class="o">&amp;</span><span class="mh">0x3fffffff</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alternately, set max digit bits to 28 since some
browsers slow down when dealing with 32-bit numbers.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">am3</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">w</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">xl</span> <span class="o">=</span> <span class="nx">x</span><span class="o">&amp;</span><span class="mh">0x3fff</span><span class="p">,</span> <span class="nx">xh</span> <span class="o">=</span> <span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x3fff</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">xh</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="nx">h</span><span class="o">*</span><span class="nx">xl</span><span class="p">;</span>
    <span class="nx">l</span> <span class="o">=</span> <span class="nx">xl</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="p">((</span><span class="nx">m</span><span class="o">&amp;</span><span class="mh">0x3fff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">)</span><span class="o">+</span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">+</span><span class="nx">c</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">l</span><span class="o">&gt;&gt;</span><span class="mi">28</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">m</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">)</span><span class="o">+</span><span class="nx">xh</span><span class="o">*</span><span class="nx">h</span><span class="p">;</span>
    <span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span><span class="o">&amp;</span><span class="mh">0xfffffff</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if(j_lm &amp;&amp; (navigator.appName == "Microsoft Internet Explorer")) {
 BigInteger.prototype.am = am2;
 dbits = 30;</p></div></div><div class="code"><div class="wrapper"><span class="c1">//}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>else if(j_lm &amp;&amp; (navigator.appName != "Netscape")) {
 BigInteger.prototype.am = am1;
 dbits = 26;</p></div></div><div class="code"><div class="wrapper"><span class="c1">//}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>else { // Mozilla/Netscape seems to prefer am3</p></div></div><div class="code"><div class="wrapper">  <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">am</span> <span class="o">=</span> <span class="nx">am3</span><span class="p">;</span>
  <span class="nx">dbits</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
<span class="c1">//}</span>

<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">DB</span> <span class="o">=</span> <span class="nx">dbits</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">DM</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">dbits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">DV</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">dbits</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">BI_FP</span> <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">FV</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">BI_FP</span><span class="p">);</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">F1</span> <span class="o">=</span> <span class="nx">BI_FP</span><span class="o">-</span><span class="nx">dbits</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">F2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nx">dbits</span><span class="o">-</span><span class="nx">BI_FP</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Digit conversions</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">BI_RM</span> <span class="o">=</span> <span class="s2">&quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BI_RC</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">rr</span><span class="p">,</span><span class="nx">vv</span><span class="p">;</span>
<span class="nx">rr</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="nx">vv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">vv</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="nx">vv</span><span class="p">)</span> <span class="nx">BI_RC</span><span class="p">[</span><span class="nx">rr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">vv</span><span class="p">;</span>
<span class="nx">rr</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="nx">vv</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">vv</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">;</span> <span class="o">++</span><span class="nx">vv</span><span class="p">)</span> <span class="nx">BI_RC</span><span class="p">[</span><span class="nx">rr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">vv</span><span class="p">;</span>
<span class="nx">rr</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="nx">vv</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">vv</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">;</span> <span class="o">++</span><span class="nx">vv</span><span class="p">)</span> <span class="nx">BI_RC</span><span class="p">[</span><span class="nx">rr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">vv</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">int2char</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">BI_RM</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">intAt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">BI_RC</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)];</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">c</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="nx">c</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) copy this to r</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpCopyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) set from integer value x, -DV &lt;= x &lt; DV</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpFromInt</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="o">+</span><span class="nx">DV</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return bigint initialized to value</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">nbv</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="nx">r</span><span class="p">.</span><span class="nx">fromInt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) set from string and radix</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpFromString</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">k</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// byte array</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">fromRadix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">mi</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">k</span><span class="o">==</span><span class="mi">8</span><span class="p">)</span><span class="o">?</span><span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="o">:</span><span class="nx">intAt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">i</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="nx">mi</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">mi</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">sh</span><span class="o">+</span><span class="nx">k</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="nx">x</span><span class="o">&amp;</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">sh</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="nx">sh</span><span class="p">;</span>
      <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">sh</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="nx">x</span><span class="o">&lt;&lt;</span><span class="nx">sh</span><span class="p">;</span>
    <span class="nx">sh</span> <span class="o">+=</span> <span class="nx">k</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">sh</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="nx">sh</span> <span class="o">-=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">k</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">sh</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">sh</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">mi</span><span class="p">)</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) clamp off excess high words</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpClamp</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">c</span><span class="p">)</span> <span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) return string representation in given radix</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnToString</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">negate</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">k</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">toRadix</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">km</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">k</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span><span class="o">%</span><span class="nx">k</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">d</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">m</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">int2char</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">&lt;</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">p</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">k</span><span class="o">-</span><span class="nx">p</span><span class="p">);</span>
        <span class="nx">d</span> <span class="o">|=</span> <span class="k">this</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">p</span><span class="o">+=</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">k</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">p</span><span class="o">-=</span><span class="nx">k</span><span class="p">))</span><span class="o">&amp;</span><span class="nx">km</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">p</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">m</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="nx">r</span> <span class="o">+=</span> <span class="nx">int2char</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">m</span><span class="o">?</span><span class="nx">r</span><span class="o">:</span><span class="s2">&quot;0&quot;</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) -this</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnNegate</span><span class="p">()</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) |this|</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnAbs</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">negate</span><span class="p">()</span><span class="o">:</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) return + if this > a, - if this &lt; a, 0 if equal</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnCompareTo</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">-</span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="nx">i</span><span class="o">-</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span><span class="p">((</span><span class="nx">r</span><span class="o">=</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">-</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns bit length of the integer x</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">nbits</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">t</span><span class="p">;</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) return the number of bits in "this"</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnBitLength</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">*</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nx">nbits</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">^</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">));</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this &lt;&lt; n*DB</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpDLShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this >> n*DB</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpDRShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">n</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this &lt;&lt; n</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpLShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bs</span> <span class="o">=</span> <span class="nx">n</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">bs</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">bm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">cbs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ds</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">n</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">),</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;&lt;</span><span class="nx">bs</span><span class="p">)</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">ds</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">cbs</span><span class="p">)</span><span class="o">|</span><span class="nx">c</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">bm</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">bs</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">ds</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">[</span><span class="nx">ds</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">ds</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this >> n</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpRShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ds</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">n</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">ds</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">bs</span> <span class="o">=</span> <span class="nx">n</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">bs</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">bm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">bs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">ds</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">bs</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">ds</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">ds</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">bm</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">cbs</span><span class="p">;</span>
    <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">ds</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">bs</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">bs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">ds</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="nx">bm</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">cbs</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">ds</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this - a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpSubTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">-</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">&gt;&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">-=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">&gt;&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">-=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">&gt;&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">c</span> <span class="o">-=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="o">+</span><span class="nx">c</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this * a, r != this,a (HAC 14.12)
"this" should be the larger one if appropriate.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpMultiplyTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">(),</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">y</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">!=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">)</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this^2, r != this (HAC 14.16)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpSquareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nx">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span><span class="o">+=</span><span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nx">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) divide this by m, quotient and remainder to q, r (HAC 14.20)
r != q, this != m.  q or r may be null.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpDivRemTo</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">q</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">pm</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">pm</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">pt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">pt</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">q</span><span class="p">.</span><span class="nx">fromInt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">r</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">(),</span> <span class="nx">ts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">nsh</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">nbits</span><span class="p">(</span><span class="nx">pm</span><span class="p">[</span><span class="nx">pm</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>  <span class="c1">// normalize modulus</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">nsh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="p">(</span><span class="nx">nsh</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="p">(</span><span class="nx">nsh</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">y0</span> <span class="o">=</span> <span class="nx">y</span><span class="p">[</span><span class="nx">ys</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">y0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">yt</span> <span class="o">=</span> <span class="nx">y0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F1</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="nx">ys</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="nx">y</span><span class="p">[</span><span class="nx">ys</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F2</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">d1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">FV</span><span class="o">/</span><span class="nx">yt</span><span class="p">,</span> <span class="nx">d2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F1</span><span class="p">)</span><span class="o">/</span><span class="nx">yt</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F2</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="o">-</span><span class="nx">ys</span><span class="p">,</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">q</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="o">?</span><span class="nx">nbi</span><span class="p">()</span><span class="o">:</span><span class="nx">q</span><span class="p">;</span>
  <span class="nx">y</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span><span class="nx">t</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="nx">ys</span><span class="p">,</span><span class="nx">t</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span> <span class="c1">// &quot;negative&quot; y so we can replace sub with am later</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">ys</span><span class="p">)</span> <span class="nx">y</span><span class="p">[</span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Estimate quotient digit</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">qd</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">]</span><span class="o">==</span><span class="nx">y0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="o">:</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">*</span><span class="nx">d1</span><span class="o">+</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nx">e</span><span class="p">)</span><span class="o">*</span><span class="nx">d2</span><span class="p">);</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+=</span><span class="nx">y</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">qd</span><span class="p">,</span><span class="nx">r</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">ys</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nx">qd</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Try it out</span>
      <span class="nx">y</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span><span class="nx">t</span><span class="p">);</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">--</span><span class="nx">qd</span><span class="p">)</span> <span class="nx">r</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">drShiftTo</span><span class="p">(</span><span class="nx">ys</span><span class="p">,</span><span class="nx">q</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">ts</span> <span class="o">!=</span> <span class="nx">ms</span><span class="p">)</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span><span class="nx">q</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">ys</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">nsh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="nx">nsh</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>  <span class="c1">// Denormalize remainder</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">ts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this mod a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnMod</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">().</span><span class="nx">divRemTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Modular reduction using "classic" algorithm</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">Classic</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">cConvert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">mod</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">cRevert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">cReduce</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">cMulTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">cSqrTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">squareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>

<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">convert</span> <span class="o">=</span> <span class="nx">cConvert</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">revert</span> <span class="o">=</span> <span class="nx">cRevert</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="nx">cReduce</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mulTo</span> <span class="o">=</span> <span class="nx">cMulTo</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sqrTo</span> <span class="o">=</span> <span class="nx">cSqrTo</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) return "-1/this % 2^DB"; useful for Mont. reduction
justification:
        xy == 1 (mod m)
        xy =  1+km
  xy(2-xy) = (1+km)(1-km)
x[y(2-xy)] = 1-k^2m^2
x[y(2-xy)] == 1 (mod m^2)
if y is 1/x mod m, then y(2-xy) is 1/x mod m^2
should reduce x and y(2-xy) by m^2 at each step to keep size bounded.
JS multiply "overflows" differently from C/C++, so care is needed here.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpInvDigit</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">;</span>    <span class="c1">// y == 1/x mod 2^2</span>
  <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span><span class="o">*</span><span class="nx">y</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">;</span>  <span class="c1">// y == 1/x mod 2^4</span>
  <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">*</span><span class="nx">y</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>  <span class="c1">// y == 1/x mod 2^8</span>
  <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="p">(((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span><span class="o">*</span><span class="nx">y</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)))</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span> <span class="c1">// y == 1/x mod 2^16</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>last step - calculate inverse mod DV directly;
assumes 16 &lt; DB &lt;= 32 and assumes ability to handle 48-bit ints</p></div></div><div class="code"><div class="wrapper">  <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="nx">x</span><span class="o">*</span><span class="nx">y</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">))</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span>    <span class="c1">// y == 1/x mod 2^dbits</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>we really want the negative inverse, and -DV &lt; y &lt; DV</p></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="p">(</span><span class="nx">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="o">-</span><span class="nx">y</span><span class="o">:-</span><span class="nx">y</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Montgomery reduction</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">Montgomery</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mp</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">invDigit</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mpl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mp</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mph</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mp</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">um</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mt2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>xR mod m</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">montConvert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="nx">x</span><span class="p">.</span><span class="nx">abs</span><span class="p">().</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>x/R mod m</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">montRevert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="nx">x</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>x = x/R mod m (HAC 14.32)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">montReduce</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mt2</span><span class="p">)</span>  <span class="c1">// pad x so am has enough room later</span>
    <span class="nx">x</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>faster way of calculating u0 = x[i]*mp mod DV</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">u0</span> <span class="o">=</span> <span class="p">(</span><span class="nx">j</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">mpl</span><span class="o">+</span><span class="p">(((</span><span class="nx">j</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">mph</span><span class="o">+</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">mpl</span><span class="p">)</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">um</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))</span><span class="o">&amp;</span><span class="nx">x</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use am to combine the multiply-shift-add into one call</p></div></div><div class="code"><div class="wrapper">    <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
    <span class="nx">x</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">u0</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>propagate carry</p></div></div><div class="code"><div class="wrapper">    <span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span> <span class="nx">x</span><span class="p">[</span><span class="o">++</span><span class="nx">j</span><span class="p">]</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">x</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
  <span class="nx">x</span><span class="p">.</span><span class="nx">drShiftTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">x</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>r = "x^2/R mod m"; x != r</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">montSqrTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">squareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>r = "xy/R mod m"; x,y != r</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">montMulTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>

<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">convert</span> <span class="o">=</span> <span class="nx">montConvert</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">revert</span> <span class="o">=</span> <span class="nx">montRevert</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="nx">montReduce</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mulTo</span> <span class="o">=</span> <span class="nx">montMulTo</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sqrTo</span> <span class="o">=</span> <span class="nx">montSqrTo</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) true iff this is even</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpIsEven</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) this^e, e &lt; 2^32, doing sqr and mul with "r" (HAC 14.79)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpExp</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">e</span> <span class="o">&gt;</span> <span class="mh">0xffffffff</span> <span class="o">||</span> <span class="nx">e</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">(),</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">(),</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">convert</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">nbits</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">g</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">z</span><span class="p">.</span><span class="nx">sqrTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r2</span><span class="p">);</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">e</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">i</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">z</span><span class="p">.</span><span class="nx">mulTo</span><span class="p">(</span><span class="nx">r2</span><span class="p">,</span><span class="nx">g</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">r2</span><span class="p">;</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">z</span><span class="p">.</span><span class="nx">revert</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this^e % m, 0 &lt;= e &lt; 2^32</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnModPowInt</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">z</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">e</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">||</span> <span class="nx">m</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="nx">z</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Classic</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span> <span class="k">else</span> <span class="nx">z</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Montgomery</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">z</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>protected</p></div></div><div class="code"><div class="wrapper"><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyTo</span> <span class="o">=</span> <span class="nx">bnpCopyTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fromInt</span> <span class="o">=</span> <span class="nx">bnpFromInt</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fromString</span> <span class="o">=</span> <span class="nx">bnpFromString</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clamp</span> <span class="o">=</span> <span class="nx">bnpClamp</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dlShiftTo</span> <span class="o">=</span> <span class="nx">bnpDLShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drShiftTo</span> <span class="o">=</span> <span class="nx">bnpDRShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lShiftTo</span> <span class="o">=</span> <span class="nx">bnpLShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rShiftTo</span> <span class="o">=</span> <span class="nx">bnpRShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subTo</span> <span class="o">=</span> <span class="nx">bnpSubTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multiplyTo</span> <span class="o">=</span> <span class="nx">bnpMultiplyTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">squareTo</span> <span class="o">=</span> <span class="nx">bnpSquareTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">divRemTo</span> <span class="o">=</span> <span class="nx">bnpDivRemTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invDigit</span> <span class="o">=</span> <span class="nx">bnpInvDigit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isEven</span> <span class="o">=</span> <span class="nx">bnpIsEven</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exp</span> <span class="o">=</span> <span class="nx">bnpExp</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>public</p></div></div><div class="code"><div class="wrapper"><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="nx">bnToString</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">negate</span> <span class="o">=</span> <span class="nx">bnNegate</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">abs</span> <span class="o">=</span> <span class="nx">bnAbs</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compareTo</span> <span class="o">=</span> <span class="nx">bnCompareTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bitLength</span> <span class="o">=</span> <span class="nx">bnBitLength</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mod</span> <span class="o">=</span> <span class="nx">bnMod</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modPowInt</span> <span class="o">=</span> <span class="nx">bnModPowInt</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>"constants"</p></div></div><div class="code"><div class="wrapper"><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnClone</span><span class="p">()</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) return value as integer</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnIntValue</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>assumes 16 &lt; DB &lt; 32</p></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="p">((</span><span class="k">this</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span><span class="o">|</span><span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) return value as byte</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnByteValue</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">:</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) return value as short (assumes DB>=16)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnShortValue</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">:</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) return x s.t. r^x &lt; DV</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpChunkSize</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">LN2</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">));</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) 0 if this == 0, 1 if this > 0</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnSigNum</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) convert to radix string</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpToRadix</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">b</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="nx">b</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">cs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">cs</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">(),</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">(),</span> <span class="nx">r</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">z</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="o">+</span><span class="nx">z</span><span class="p">.</span><span class="nx">intValue</span><span class="p">()).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">b</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">r</span><span class="p">;</span>
    <span class="nx">y</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">z</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">z</span><span class="p">.</span><span class="nx">intValue</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">+</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) convert from radix string</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpFromRadix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">fromInt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">cs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">cs</span><span class="p">),</span> <span class="nx">mi</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">intAt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">i</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">mi</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">w</span> <span class="o">=</span> <span class="nx">b</span><span class="o">*</span><span class="nx">w</span><span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&gt;=</span> <span class="nx">cs</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dMultiply</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dAddOffset</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dMultiply</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">j</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dAddOffset</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">mi</span><span class="p">)</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) alternate constructor</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpFromNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="s2">&quot;number&quot;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>new BigInteger(int,int,RNG)</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span><span class="p">(</span><span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fromInt</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fromNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">testBit</span><span class="p">(</span><span class="nx">a</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>  <span class="c1">// force MSB set</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">bitwiseTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">shiftLeft</span><span class="p">(</span><span class="nx">a</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nx">op_or</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="k">this</span><span class="p">.</span><span class="nx">dAddOffset</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// force odd</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isProbablePrime</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dAddOffset</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">shiftLeft</span><span class="p">(</span><span class="nx">a</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>new BigInteger(int,RNG)</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(),</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">a</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">;</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">nextBytes</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="k">else</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fromString</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) convert to bigendian byte array</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnToByteArray</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
  <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span><span class="o">%</span><span class="mi">8</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">d</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">p</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="nx">p</span><span class="p">)</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="o">|</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">p</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">p</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nx">p</span><span class="p">);</span>
        <span class="nx">d</span> <span class="o">|=</span> <span class="k">this</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">p</span><span class="o">+=</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">p</span><span class="o">-=</span><span class="mi">8</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">p</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if((d&amp;0x80) != 0) d |= -256;
if(k == 0 &amp;&amp; (this.s&amp;0x80) != (d&amp;0x80)) ++k;</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span><span class="p">(</span><span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">d</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">bnEquals</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">bnMin</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="o">:</span><span class="nx">a</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">bnMax</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="o">:</span><span class="nx">a</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this op a (bitwise)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpBitwiseTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">op</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">f</span><span class="p">);</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="nx">op</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this &amp; a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">op_and</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="o">&amp;</span><span class="nx">y</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">bnAnd</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitwiseTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">op_and</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this | a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">op_or</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="o">|</span><span class="nx">y</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">bnOr</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitwiseTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">op_or</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this ^ a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">op_xor</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="o">^</span><span class="nx">y</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">bnXor</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitwiseTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">op_xor</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this &amp; ~a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">op_andnot</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="o">&amp;~</span><span class="nx">y</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">bnAndNot</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitwiseTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">op_andnot</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) ~this</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnNot</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="o">&amp;~</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="o">~</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this &lt;&lt; n</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnShiftLeft</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="o">-</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this >> n</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnShiftRight</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="p">(</span><span class="o">-</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return index of lowest 1-bit in x, x &lt; 2^31</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">lbit</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span><span class="p">((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">++</span><span class="nx">r</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) returns index of lowest 1-bit (or -1 if none)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnGetLowestSetBit</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">+</span><span class="nx">lbit</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return number of 1 bits in x</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">cbit</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">&amp;=</span> <span class="nx">x</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">r</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) return number of set bits</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnBitCount</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span> <span class="o">+=</span> <span class="nx">cbit</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">^</span><span class="nx">x</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) true iff nth bit is set</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnTestBit</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">n</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">j</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span><span class="p">((</span><span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">n</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)))</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) this op (1&lt;<n)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpChangeBit</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">shiftLeft</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">bitwiseTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">op</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this | (1&lt;<n)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnSetBit</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">changeBit</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">op_or</span><span class="p">);</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this &amp; ~(1&lt;<n)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnClearBit</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">changeBit</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">op_andnot</span><span class="p">);</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this ^ (1&lt;<n)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnFlipBit</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">changeBit</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">op_xor</span><span class="p">);</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = this + a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpAddTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">&gt;&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">&gt;&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">+=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">&gt;&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">c</span> <span class="o">+=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="o">+</span><span class="nx">c</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this + a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnAdd</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this - a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnSubtract</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this * a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnMultiply</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this^2</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnSquare</span><span class="p">()</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">squareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this / a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnDivide</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this % a</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnRemainder</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) [this/a,this%a]</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnDivideAndRemainder</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">(),</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">q</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) this *= n, this >= 0, 1 &lt; n &lt; DV</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpDMultiply</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
  <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) this += n &lt;&lt; w words, this >= 0</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpDAddOffset</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">&lt;=</span> <span class="nx">w</span><span class="p">)</span> <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">[</span><span class="nx">w</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">w</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">[</span><span class="nx">w</span><span class="p">]</span> <span class="o">-=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="nx">w</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">++</span><span class="k">this</span><span class="p">[</span><span class="nx">w</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A "null" reducer</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">NullExp</span><span class="p">()</span> <span class="p">{}</span>
<span class="kd">function</span> <span class="nx">nNop</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">nMulTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">nSqrTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">squareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>

<span class="nx">NullExp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">convert</span> <span class="o">=</span> <span class="nx">nNop</span><span class="p">;</span>
<span class="nx">NullExp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">revert</span> <span class="o">=</span> <span class="nx">nNop</span><span class="p">;</span>
<span class="nx">NullExp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mulTo</span> <span class="o">=</span> <span class="nx">nMulTo</span><span class="p">;</span>
<span class="nx">NullExp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sqrTo</span> <span class="o">=</span> <span class="nx">nSqrTo</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this^e</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnPow</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="k">new</span> <span class="nx">NullExp</span><span class="p">());</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = lower n words of "this * a", a.t &lt;= n
"this" should be the larger one if appropriate.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpMultiplyLowerTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// assumes a,this &gt;= 0</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">j</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">n</span><span class="o">-</span><span class="nx">i</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) r = "this * a" without lower n words, n > 0
"this" should be the larger one if appropriate.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpMultiplyUpperTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">--</span><span class="nx">n</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// assumes a,this &gt;= 0</span>
  <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
    <span class="nx">r</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">i</span><span class="o">-</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="nx">i</span><span class="p">,</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">i</span><span class="o">-</span><span class="nx">n</span><span class="p">);</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">drShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Barrett modular reduction</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">Barrett</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>setup Barrett</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">r2</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">q3</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">r2</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mu</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">r2</span><span class="p">.</span><span class="nx">divide</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">barrettConvert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">x</span><span class="p">.</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">mod</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span> <span class="nx">x</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">barrettRevert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>x = x mod m (HAC 14.42)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">barrettReduce</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">x</span><span class="p">.</span><span class="nx">drShiftTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">r2</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span> <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">multiplyUpperTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">r2</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">q3</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">multiplyLowerTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">q3</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">r2</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">r2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">x</span><span class="p">.</span><span class="nx">dAddOffset</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">x</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">r2</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">x</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>r = x^2 mod m; x != r</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">barrettSqrTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">squareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>r = x*y mod m; x,y != r</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">barrettMulTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="p">}</span>

<span class="nx">Barrett</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">convert</span> <span class="o">=</span> <span class="nx">barrettConvert</span><span class="p">;</span>
<span class="nx">Barrett</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">revert</span> <span class="o">=</span> <span class="nx">barrettRevert</span><span class="p">;</span>
<span class="nx">Barrett</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="nx">barrettReduce</span><span class="p">;</span>
<span class="nx">Barrett</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mulTo</span> <span class="o">=</span> <span class="nx">barrettMulTo</span><span class="p">;</span>
<span class="nx">Barrett</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sqrTo</span> <span class="o">=</span> <span class="nx">barrettSqrTo</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) this^e % m (HAC 14.85)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnModPow</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">(),</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">z</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">144</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">768</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="k">else</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="nx">z</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Classic</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span>
    <span class="nx">z</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Barrett</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="nx">z</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Montgomery</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>precomputation</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(),</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">=</span> <span class="nx">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">km</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">k</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">convert</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">g2</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
    <span class="nx">z</span><span class="p">.</span><span class="nx">sqrTo</span><span class="p">(</span><span class="nx">g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nx">g2</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">n</span> <span class="o">&lt;=</span> <span class="nx">km</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">g</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
      <span class="nx">z</span><span class="p">.</span><span class="nx">mulTo</span><span class="p">(</span><span class="nx">g2</span><span class="p">,</span><span class="nx">g</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="nx">g</span><span class="p">[</span><span class="nx">n</span><span class="p">]);</span>
      <span class="nx">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">is1</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">(),</span> <span class="nx">t</span><span class="p">;</span>
  <span class="nx">i</span> <span class="o">=</span> <span class="nx">nbits</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">k1</span><span class="p">)</span> <span class="nx">w</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">i</span><span class="o">-</span><span class="nx">k1</span><span class="p">))</span><span class="o">&amp;</span><span class="nx">km</span><span class="p">;</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">w</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">&amp;</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">k1</span><span class="o">-</span><span class="nx">i</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">w</span> <span class="o">|=</span> <span class="nx">e</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">+</span><span class="nx">i</span><span class="o">-</span><span class="nx">k1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">n</span> <span class="o">=</span> <span class="nx">k</span><span class="p">;</span>
    <span class="k">while</span><span class="p">((</span><span class="nx">w</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">w</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">--</span><span class="nx">n</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">i</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">i</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span> <span class="o">--</span><span class="nx">j</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">is1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ret == 1, don&#39;t bother squaring or multiplying it</span>
      <span class="nx">g</span><span class="p">[</span><span class="nx">w</span><span class="p">].</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
      <span class="nx">is1</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">z</span><span class="p">.</span><span class="nx">sqrTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r2</span><span class="p">);</span> <span class="nx">z</span><span class="p">.</span><span class="nx">sqrTo</span><span class="p">(</span><span class="nx">r2</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span> <span class="nx">n</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">z</span><span class="p">.</span><span class="nx">sqrTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r2</span><span class="p">);</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">r2</span><span class="p">;</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="p">}</span>
      <span class="nx">z</span><span class="p">.</span><span class="nx">mulTo</span><span class="p">(</span><span class="nx">r2</span><span class="p">,</span><span class="nx">g</span><span class="p">[</span><span class="nx">w</span><span class="p">],</span><span class="nx">r</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span><span class="p">(</span><span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">z</span><span class="p">.</span><span class="nx">sqrTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r2</span><span class="p">);</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">r2</span><span class="p">;</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">--</span><span class="nx">j</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">z</span><span class="p">.</span><span class="nx">revert</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) gcd(this,a) (HAC 14.54)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnGCD</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">negate</span><span class="p">()</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="nx">a</span><span class="p">.</span><span class="nx">negate</span><span class="p">()</span><span class="o">:</span><span class="nx">a</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">getLowestSetBit</span><span class="p">(),</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">getLowestSetBit</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">g</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">g</span><span class="p">)</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">g</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
    <span class="nx">y</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">getLowestSetBit</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">x</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">getLowestSetBit</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">y</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
      <span class="nx">x</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">y</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
      <span class="nx">y</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">g</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">y</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">y</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) this % n, n &lt; 2^26</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpModInt</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="o">%</span><span class="nx">n</span><span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="nx">n</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="o">*</span><span class="nx">r</span><span class="o">+</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="o">%</span><span class="nx">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) 1/this % m (HAC 14.61)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnModInverse</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ac</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">isEven</span><span class="p">();</span>
  <span class="k">if</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">isEven</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">ac</span><span class="p">)</span> <span class="o">||</span> <span class="nx">m</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">u</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">clone</span><span class="p">(),</span> <span class="nx">v</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">nbv</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">u</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">u</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">ac</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">isEven</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="p">{</span> <span class="nx">a</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">a</span><span class="p">);</span> <span class="nx">b</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span> <span class="p">}</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">a</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="nx">b</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span>
      <span class="nx">b</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">v</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">v</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">ac</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">isEven</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="nx">d</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span> <span class="nx">d</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">d</span><span class="p">);</span> <span class="p">}</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">d</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="nx">d</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">d</span><span class="p">);</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">d</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">u</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span><span class="nx">u</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">ac</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="nx">a</span><span class="p">);</span>
      <span class="nx">b</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">v</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span><span class="nx">v</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">ac</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">d</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">d</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">d</span><span class="p">);</span> <span class="k">else</span> <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">signum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span> <span class="k">else</span> <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">lowprimes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">71</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">79</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">137</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">149</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">157</span><span class="p">,</span><span class="mi">163</span><span class="p">,</span><span class="mi">167</span><span class="p">,</span><span class="mi">173</span><span class="p">,</span><span class="mi">179</span><span class="p">,</span><span class="mi">181</span><span class="p">,</span><span class="mi">191</span><span class="p">,</span><span class="mi">193</span><span class="p">,</span><span class="mi">197</span><span class="p">,</span><span class="mi">199</span><span class="p">,</span><span class="mi">211</span><span class="p">,</span><span class="mi">223</span><span class="p">,</span><span class="mi">227</span><span class="p">,</span><span class="mi">229</span><span class="p">,</span><span class="mi">233</span><span class="p">,</span><span class="mi">239</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="mi">251</span><span class="p">,</span><span class="mi">257</span><span class="p">,</span><span class="mi">263</span><span class="p">,</span><span class="mi">269</span><span class="p">,</span><span class="mi">271</span><span class="p">,</span><span class="mi">277</span><span class="p">,</span><span class="mi">281</span><span class="p">,</span><span class="mi">283</span><span class="p">,</span><span class="mi">293</span><span class="p">,</span><span class="mi">307</span><span class="p">,</span><span class="mi">311</span><span class="p">,</span><span class="mi">313</span><span class="p">,</span><span class="mi">317</span><span class="p">,</span><span class="mi">331</span><span class="p">,</span><span class="mi">337</span><span class="p">,</span><span class="mi">347</span><span class="p">,</span><span class="mi">349</span><span class="p">,</span><span class="mi">353</span><span class="p">,</span><span class="mi">359</span><span class="p">,</span><span class="mi">367</span><span class="p">,</span><span class="mi">373</span><span class="p">,</span><span class="mi">379</span><span class="p">,</span><span class="mi">383</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">397</span><span class="p">,</span><span class="mi">401</span><span class="p">,</span><span class="mi">409</span><span class="p">,</span><span class="mi">419</span><span class="p">,</span><span class="mi">421</span><span class="p">,</span><span class="mi">431</span><span class="p">,</span><span class="mi">433</span><span class="p">,</span><span class="mi">439</span><span class="p">,</span><span class="mi">443</span><span class="p">,</span><span class="mi">449</span><span class="p">,</span><span class="mi">457</span><span class="p">,</span><span class="mi">461</span><span class="p">,</span><span class="mi">463</span><span class="p">,</span><span class="mi">467</span><span class="p">,</span><span class="mi">479</span><span class="p">,</span><span class="mi">487</span><span class="p">,</span><span class="mi">491</span><span class="p">,</span><span class="mi">499</span><span class="p">,</span><span class="mi">503</span><span class="p">,</span><span class="mi">509</span><span class="p">,</span><span class="mi">521</span><span class="p">,</span><span class="mi">523</span><span class="p">,</span><span class="mi">541</span><span class="p">,</span><span class="mi">547</span><span class="p">,</span><span class="mi">557</span><span class="p">,</span><span class="mi">563</span><span class="p">,</span><span class="mi">569</span><span class="p">,</span><span class="mi">571</span><span class="p">,</span><span class="mi">577</span><span class="p">,</span><span class="mi">587</span><span class="p">,</span><span class="mi">593</span><span class="p">,</span><span class="mi">599</span><span class="p">,</span><span class="mi">601</span><span class="p">,</span><span class="mi">607</span><span class="p">,</span><span class="mi">613</span><span class="p">,</span><span class="mi">617</span><span class="p">,</span><span class="mi">619</span><span class="p">,</span><span class="mi">631</span><span class="p">,</span><span class="mi">641</span><span class="p">,</span><span class="mi">643</span><span class="p">,</span><span class="mi">647</span><span class="p">,</span><span class="mi">653</span><span class="p">,</span><span class="mi">659</span><span class="p">,</span><span class="mi">661</span><span class="p">,</span><span class="mi">673</span><span class="p">,</span><span class="mi">677</span><span class="p">,</span><span class="mi">683</span><span class="p">,</span><span class="mi">691</span><span class="p">,</span><span class="mi">701</span><span class="p">,</span><span class="mi">709</span><span class="p">,</span><span class="mi">719</span><span class="p">,</span><span class="mi">727</span><span class="p">,</span><span class="mi">733</span><span class="p">,</span><span class="mi">739</span><span class="p">,</span><span class="mi">743</span><span class="p">,</span><span class="mi">751</span><span class="p">,</span><span class="mi">757</span><span class="p">,</span><span class="mi">761</span><span class="p">,</span><span class="mi">769</span><span class="p">,</span><span class="mi">773</span><span class="p">,</span><span class="mi">787</span><span class="p">,</span><span class="mi">797</span><span class="p">,</span><span class="mi">809</span><span class="p">,</span><span class="mi">811</span><span class="p">,</span><span class="mi">821</span><span class="p">,</span><span class="mi">823</span><span class="p">,</span><span class="mi">827</span><span class="p">,</span><span class="mi">829</span><span class="p">,</span><span class="mi">839</span><span class="p">,</span><span class="mi">853</span><span class="p">,</span><span class="mi">857</span><span class="p">,</span><span class="mi">859</span><span class="p">,</span><span class="mi">863</span><span class="p">,</span><span class="mi">877</span><span class="p">,</span><span class="mi">881</span><span class="p">,</span><span class="mi">883</span><span class="p">,</span><span class="mi">887</span><span class="p">,</span><span class="mi">907</span><span class="p">,</span><span class="mi">911</span><span class="p">,</span><span class="mi">919</span><span class="p">,</span><span class="mi">929</span><span class="p">,</span><span class="mi">937</span><span class="p">,</span><span class="mi">941</span><span class="p">,</span><span class="mi">947</span><span class="p">,</span><span class="mi">953</span><span class="p">,</span><span class="mi">967</span><span class="p">,</span><span class="mi">971</span><span class="p">,</span><span class="mi">977</span><span class="p">,</span><span class="mi">983</span><span class="p">,</span><span class="mi">991</span><span class="p">,</span><span class="mi">997</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">lplim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">26</span><span class="p">)</span><span class="o">/</span><span class="nx">lowprimes</span><span class="p">[</span><span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(public) test primality with certainty >= 1-.5^t</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnIsProbablePrime</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">lowprimes</span><span class="p">[</span><span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">lowprimes</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">lowprimes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">lplim</span><span class="p">)</span> <span class="nx">m</span> <span class="o">*=</span> <span class="nx">lowprimes</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">];</span>
    <span class="nx">m</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">modInt</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">)</span> <span class="k">if</span><span class="p">(</span><span class="nx">m</span><span class="o">%</span><span class="nx">lowprimes</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">millerRabin</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">bnToMPI</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ba</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toByteArray</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ba</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="nx">nbits</span><span class="p">(</span><span class="nx">ba</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="nx">result</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">((</span><span class="nx">size</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
  <span class="nx">result</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">size</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
  <span class="nx">result</span> <span class="o">+=</span> <span class="nx">bin2str</span><span class="p">(</span><span class="nx">ba</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* END of addition */</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>(protected) true if probably prime (HAC 4.24, Miller-Rabin)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bnpMillerRabin</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">getLowestSetBit</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">k</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">shiftRight</span><span class="p">(</span><span class="nx">k</span><span class="p">);</span>
  <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">nbi</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">t</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pick bases at random, instead of starting at 2</p></div></div><div class="code"><div class="wrapper">    <span class="nx">a</span><span class="p">.</span><span class="nx">fromInt</span><span class="p">(</span><span class="nx">lowprimes</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">lowprimes</span><span class="p">.</span><span class="nx">length</span><span class="p">)]);</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">modPow</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">n1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">j</span><span class="o">++</span> <span class="o">&lt;</span> <span class="nx">k</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">n1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">modPowInt</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">n1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>protected</p></div></div><div class="code"><div class="wrapper"><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">chunkSize</span> <span class="o">=</span> <span class="nx">bnpChunkSize</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toRadix</span> <span class="o">=</span> <span class="nx">bnpToRadix</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fromRadix</span> <span class="o">=</span> <span class="nx">bnpFromRadix</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fromNumber</span> <span class="o">=</span> <span class="nx">bnpFromNumber</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bitwiseTo</span> <span class="o">=</span> <span class="nx">bnpBitwiseTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">changeBit</span> <span class="o">=</span> <span class="nx">bnpChangeBit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addTo</span> <span class="o">=</span> <span class="nx">bnpAddTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dMultiply</span> <span class="o">=</span> <span class="nx">bnpDMultiply</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dAddOffset</span> <span class="o">=</span> <span class="nx">bnpDAddOffset</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multiplyLowerTo</span> <span class="o">=</span> <span class="nx">bnpMultiplyLowerTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multiplyUpperTo</span> <span class="o">=</span> <span class="nx">bnpMultiplyUpperTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modInt</span> <span class="o">=</span> <span class="nx">bnpModInt</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">millerRabin</span> <span class="o">=</span> <span class="nx">bnpMillerRabin</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>public</p></div></div><div class="code"><div class="wrapper"><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="nx">bnClone</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">intValue</span> <span class="o">=</span> <span class="nx">bnIntValue</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">byteValue</span> <span class="o">=</span> <span class="nx">bnByteValue</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shortValue</span> <span class="o">=</span> <span class="nx">bnShortValue</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">signum</span> <span class="o">=</span> <span class="nx">bnSigNum</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toByteArray</span> <span class="o">=</span> <span class="nx">bnToByteArray</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">equals</span> <span class="o">=</span> <span class="nx">bnEquals</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="nx">bnMin</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="nx">bnMax</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">and</span> <span class="o">=</span> <span class="nx">bnAnd</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">or</span> <span class="o">=</span> <span class="nx">bnOr</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">xor</span> <span class="o">=</span> <span class="nx">bnXor</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">andNot</span> <span class="o">=</span> <span class="nx">bnAndNot</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">not</span> <span class="o">=</span> <span class="nx">bnNot</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shiftLeft</span> <span class="o">=</span> <span class="nx">bnShiftLeft</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shiftRight</span> <span class="o">=</span> <span class="nx">bnShiftRight</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getLowestSetBit</span> <span class="o">=</span> <span class="nx">bnGetLowestSetBit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bitCount</span> <span class="o">=</span> <span class="nx">bnBitCount</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">testBit</span> <span class="o">=</span> <span class="nx">bnTestBit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setBit</span> <span class="o">=</span> <span class="nx">bnSetBit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clearBit</span> <span class="o">=</span> <span class="nx">bnClearBit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flipBit</span> <span class="o">=</span> <span class="nx">bnFlipBit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="nx">bnAdd</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subtract</span> <span class="o">=</span> <span class="nx">bnSubtract</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multiply</span> <span class="o">=</span> <span class="nx">bnMultiply</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">divide</span> <span class="o">=</span> <span class="nx">bnDivide</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remainder</span> <span class="o">=</span> <span class="nx">bnRemainder</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">divideAndRemainder</span> <span class="o">=</span> <span class="nx">bnDivideAndRemainder</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modPow</span> <span class="o">=</span> <span class="nx">bnModPow</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modInverse</span> <span class="o">=</span> <span class="nx">bnModInverse</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pow</span> <span class="o">=</span> <span class="nx">bnPow</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gcd</span> <span class="o">=</span> <span class="nx">bnGCD</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isProbablePrime</span> <span class="o">=</span> <span class="nx">bnIsProbablePrime</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toMPI</span> <span class="o">=</span> <span class="nx">bnToMPI</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>JSBN-specific extension</p></div></div><div class="code"><div class="wrapper"><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">square</span> <span class="o">=</span> <span class="nx">bnSquare</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * return a pseudo-random number in the specified range</span>
<span class="cm"> * @param from [Integer] min of the random number</span>
<span class="cm"> * @param to [Integer] max of the random number (max 32bit)</span>
<span class="cm"> * @return [Integer] a pseudo random number</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">openpgp_crypto_getPseudoRandom</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="nx">to</span><span class="o">-</span><span class="nx">from</span><span class="p">))</span><span class="o">+</span><span class="nx">from</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">openpgp_crypto_getSecureRandomOctet</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">openpgp_crypto_getPseudoRandom</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> 
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * retrieve secure random byte string of the specified length</span>
<span class="cm"> * @param length [Integer] length in bytes to generate</span>
<span class="cm"> * @return [String] random byte string</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">openpgp_crypto_getRandomBytes</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">_cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">openpgp_crypto_getSecureRandomOctet</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * create a secure random big integer of bits length</span>
<span class="cm"> * @param bits [Integer] bit length of the MPI to create</span>
<span class="cm"> * @return [BigInteger] resulting big integer</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">openpgp_crypto_getRandomBigInteger</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
     <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">numBytes</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">bits</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">randomBits</span> <span class="o">=</span> <span class="nx">openpgp_crypto_getRandomBytes</span><span class="p">(</span><span class="nx">numBytes</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="nx">randomBits</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">bits</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="nx">randomBits</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span>
      <span class="nx">randomBits</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">_toHex</span><span class="p">(</span><span class="nx">randomBits</span><span class="p">)).</span><span class="nx">toBigInteger</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">openpgp_crypto_getRandomBigIntegerInRange</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if (max &lt; min)
return;</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">max</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">min</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">openpgp_crypto_getRandomBigInteger</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">());</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&gt;</span> <span class="nx">range</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="nx">openpgp_crypto_getRandomBigInteger</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">min</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>  
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">Elgamal</span><span class="p">()</span> <span class="p">{</span>
  
  <span class="kd">function</span> <span class="nx">encrypt</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">g</span><span class="p">,</span><span class="nx">p</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>choose k in {2,...,p-2}</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">two</span> <span class="o">=</span> <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pMinus2</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">two</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">openpgp_crypto_getRandomBigIntegerInRange</span><span class="p">(</span><span class="nx">two</span><span class="p">,</span> <span class="nx">pMinus2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">mod</span><span class="p">(</span><span class="nx">pMinus2</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">modPow</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">p</span><span class="p">);</span>
    <span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">modPow</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">p</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">m</span><span class="p">).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nx">toMPI</span><span class="p">();</span>
    <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toMPI</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nx">decrypt</span><span class="p">(</span><span class="nx">c1</span><span class="p">,</span><span class="nx">c2</span><span class="p">,</span><span class="nx">p</span><span class="p">,</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>util.print_debug("Elgamal Decrypt:\nc1:"+util.hexstrdump(c1.toMPI())+"\n"+
  "c2:"+util.hexstrdump(c2.toMPI())+"\n"+
  "p:"+util.hexstrdump(p.toMPI())+"\n"+
  "x:"+util.hexstrdump(x.toMPI()));</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c1</span><span class="p">.</span><span class="nx">modPow</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">).</span><span class="nx">modInverse</span><span class="p">(</span><span class="nx">p</span><span class="p">)).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">c2</span><span class="p">).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">toMPI</span><span class="p">();</span>
  <span class="p">}</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>signing and signature verification using Elgamal is not required by OpenPGP.</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">encrypt</span> <span class="o">=</span> <span class="nx">encrypt</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">decrypt</span> <span class="o">=</span> <span class="nx">decrypt</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>GPG4Browsers - An OpenPGP implementation in javascript
Copyright (C) 2011 Recurity Labs GmbH</p>

<p>This library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.</p>

<p>This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.</p>

<p>You should have received a copy of the GNU Lesser General Public
License along with this library; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</p>

<p>A Digital signature algorithm implementation</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">DSA</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>s1 = ((g<strong>s) mod p) mod q
s1 = ((s</strong>-1)<em>(sha-1(m)+(s1</em>x) mod q)</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">sign</span><span class="p">(</span><span class="nx">hashalgo</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the output size of the chosen hash is larger than the number of
bits of q, the hash result is truncated to fit by taking the number
of leftmost bits equal to the number of bits of q.  This (possibly
truncated) hash function result is treated as a number and used
directly in the DSA signature algorithm.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">hashed_data</span> <span class="o">=</span> <span class="nx">getLeftNBits</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">q</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigInteger</span><span class="p">(</span><span class="nx">hexstrdump</span><span class="p">(</span><span class="nx">hashed_data</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">openpgp_crypto_getRandomBigIntegerInRange</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">),</span> <span class="nx">q</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">s1</span> <span class="o">=</span> <span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">modPow</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span><span class="nx">p</span><span class="p">)).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">q</span><span class="p">);</span> 
    <span class="kd">var</span> <span class="nx">s2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">modInverse</span><span class="p">(</span><span class="nx">q</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">hash</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">s1</span><span class="p">)))).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">q</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">toMPI</span><span class="p">();</span>
    <span class="nx">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">toMPI</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">select_hash_algorithm</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">usersetting</span> <span class="o">=</span> <span class="nx">openpgp</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">prefer_hash_algorithm</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * 1024-bit key, 160-bit q, SHA-1, SHA-224, SHA-256, SHA-384, or SHA-512 hash</span>
<span class="cm">     * 2048-bit key, 224-bit q, SHA-224, SHA-256, SHA-384, or SHA-512 hash</span>
<span class="cm">     * 2048-bit key, 256-bit q, SHA-256, SHA-384, or SHA-512 hash</span>
<span class="cm">     * 3072-bit key, 256-bit q, SHA-256, SHA-384, or SHA-512 hash</span>
<span class="cm">     */</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">()</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">20</span><span class="o">:</span> <span class="c1">// 1024 bit</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usersetting</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
        <span class="nx">usersetting</span> <span class="o">&gt;</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span>
        <span class="nx">usersetting</span> <span class="o">!=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span>
        <span class="nx">usersetting</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// prefer sha1</span>
      <span class="k">return</span> <span class="nx">usersetting</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">28</span><span class="o">:</span> <span class="c1">// 2048 bit</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usersetting</span> <span class="o">&gt;</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span>
          <span class="nx">usersetting</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
          <span class="k">return</span> <span class="mi">11</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">usersetting</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">32</span><span class="o">:</span> <span class="c1">// 4096 bit // prefer sha224</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usersetting</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span>
          <span class="nx">usersetting</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
          <span class="k">return</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// prefer sha256</span>
      <span class="k">return</span> <span class="nx">usersetting</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="nx">print_debug</span><span class="p">(</span><span class="s2">&quot;DSA select hash algorithm: returning null for an unknown length of q&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">select_hash_algorithm</span> <span class="o">=</span> <span class="nx">select_hash_algorithm</span><span class="p">;</span>
  
  <span class="kd">function</span> <span class="nx">verify</span><span class="p">(</span><span class="nx">hashalgo</span><span class="p">,</span> <span class="nx">hashdata</span><span class="p">,</span> <span class="nx">s1</span><span class="p">,</span><span class="nx">s2</span><span class="p">,</span><span class="nx">m</span><span class="p">,</span><span class="nx">p</span><span class="p">,</span><span class="nx">q</span><span class="p">,</span><span class="nx">g</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hashed_data</span> <span class="o">=</span> <span class="nx">getLeftNBits</span><span class="p">(</span><span class="nx">hashdata</span><span class="p">,</span><span class="nx">q</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigInteger</span><span class="p">(</span><span class="nx">hexstrdump</span><span class="p">(</span><span class="nx">hashed_data</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span> 
    <span class="k">if</span> <span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">s1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="nx">s1</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">s2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="nx">s2</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">modInverse</span><span class="p">(</span><span class="nx">q</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">u1</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">q</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">u2</span> <span class="o">=</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">q</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">dopublic</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">modPow</span><span class="p">(</span><span class="nx">u1</span><span class="p">,</span><span class="nx">p</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">modPow</span><span class="p">(</span><span class="nx">u2</span><span class="p">,</span><span class="nx">p</span><span class="p">)).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nx">mod</span><span class="p">(</span><span class="nx">q</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">dopublic</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">s1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="cm">/*</span>
<span class="cm">   * unused code. This can be used as a start to write a key generator</span>
<span class="cm">   * function.</span>
<span class="cm">  </span>
<span class="cm">  function generateKey(bitcount) {</span>
<span class="cm">      var qi = new BigInteger(bitcount, primeCenterie);</span>
<span class="cm">      var pi = generateP(q, 512);</span>
<span class="cm">      var gi = generateG(p, q, bitcount);</span>
<span class="cm">      var xi;</span>
<span class="cm">      do {</span>
<span class="cm">          xi = new BigInteger(q.bitCount(), rand);</span>
<span class="cm">      } while (x.compareTo(BigInteger.ZERO) != 1 &amp;&amp; x.compareTo(q) != -1);</span>
<span class="cm">      var yi = g.modPow(x, p);</span>
<span class="cm">      return {x: xi, q: qi, p: pi, g: gi, y: yi};</span>
<span class="cm">  }</span>

<span class="cm">  function generateP(q, bitlength, randomfn) {</span>
<span class="cm">      if (bitlength % 64 != 0) {</span>
<span class="cm">        return false;</span>
<span class="cm">      }</span>
<span class="cm">      var pTemp;</span>
<span class="cm">      var pTemp2;</span>
<span class="cm">      do {</span>
<span class="cm">          pTemp = randomfn(bitcount, true);</span>
<span class="cm">          pTemp2 = pTemp.subtract(BigInteger.ONE);</span>
<span class="cm">          pTemp = pTemp.subtract(pTemp2.remainder(q));</span>
<span class="cm">      } while (!pTemp.isProbablePrime(primeCenterie) || pTemp.bitLength() != l);</span>
<span class="cm">      return pTemp;</span>
<span class="cm">  }</span>
<span class="cm">  </span>
<span class="cm">  function generateG(p, q, bitlength, randomfn) {</span>
<span class="cm">      var aux = p.subtract(BigInteger.ONE);</span>
<span class="cm">      var pow = aux.divide(q);</span>
<span class="cm">      var gTemp;</span>
<span class="cm">      do {</span>
<span class="cm">          gTemp = randomfn(bitlength);</span>
<span class="cm">      } while (gTemp.compareTo(aux) != -1 &amp;&amp; gTemp.compareTo(BigInteger.ONE) != 1);</span>
<span class="cm">      return gTemp.modPow(pow, p);</span>
<span class="cm">  }</span>

<span class="cm">  function generateK(q, bitlength, randomfn) {</span>
<span class="cm">      var tempK;</span>
<span class="cm">      do {</span>
<span class="cm">          tempK = randomfn(bitlength, false);</span>
<span class="cm">      } while (tempK.compareTo(q) != -1 &amp;&amp; tempK.compareTo(BigInteger.ZERO) != 1);</span>
<span class="cm">      return tempK;</span>
<span class="cm">  }</span>

<span class="cm">  function generateR(q,p) {</span>
<span class="cm">      k = generateK(q);</span>
<span class="cm">      var r = g.modPow(k, p).mod(q);</span>
<span class="cm">      return r;</span>
<span class="cm">  }</span>

<span class="cm">  function generateS(hashfn,k,r,m,q,x) {</span>
<span class="cm">        var hash = hashfn(m);</span>
<span class="cm">        s = (k.modInverse(q).multiply(hash.add(x.multiply(r)))).mod(q);</span>
<span class="cm">      return s;</span>
<span class="cm">  } */</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sign</span> <span class="o">=</span> <span class="nx">sign</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">verify</span> <span class="o">=</span> <span class="nx">verify</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>this.generate = generateKey;</p></div></div><div class="code"><div class="wrapper"><span class="p">}</span>


<span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">aEvent</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">ts</span> <span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
  

  <span class="k">switch</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">ACTION</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;Elgamal&#39;</span><span class="o">:</span>
    <span class="kd">var</span> <span class="nx">elgamal</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Elgamal</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">m</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">g</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">p</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">value</span><span class="o">=</span> <span class="nx">elgamal</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
    <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">res</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;ElgamalDecrypt&#39;</span><span class="o">:</span>
    <span class="kd">var</span> <span class="nx">elgamal</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Elgamal</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">c1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">c1</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">c2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">c2</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">p</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">elgamal</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">c1</span><span class="p">,</span><span class="nx">c2</span><span class="p">,</span><span class="nx">p</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span> 
    <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">res</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;DSAVerify&#39;</span><span class="o">:</span>
    <span class="kd">var</span> <span class="nx">dsa</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DSA</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">s1</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">s2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">s2</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">p</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">q</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">g</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">m</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">hash_algo</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">hash_algo</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hash_data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">hash_data</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">dsa</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">hash_algo</span><span class="p">,</span><span class="nx">hash_data</span><span class="p">,</span><span class="nx">s1</span><span class="p">,</span><span class="nx">s2</span><span class="p">,</span><span class="nx">m</span><span class="p">,</span><span class="nx">p</span><span class="p">,</span><span class="nx">q</span><span class="p">,</span><span class="nx">g</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
    <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">res</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;DSASign&#39;</span><span class="o">:</span>
    <span class="kd">var</span> <span class="nx">dsa</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DSA</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">m</span><span class="p">;</span><span class="c1">//new mpi_t(aEvent.data.m).toBigInteger();</span>
    <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">g</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">p</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">q</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mpi_t</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBigInteger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">hash_algo</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">hash_algo</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hash_data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">hash_data</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">dsa</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">hash_algo</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">result</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">res</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div></div></body></html>