<!DOCTYPE html><html lang="en"><head><title>workers/domcrypt_worker</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="workers/domcrypt_worker"><meta name="groc-project-path" content="lib/workers/domcrypt_worker.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/workers/domcrypt_worker.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="cm">/* ***** BEGIN LICENSE BLOCK *****</span>
<span class="cm"> * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<span class="cm"> *</span>
<span class="cm"> * The contents of this file are subject to the Mozilla Public License Version</span>
<span class="cm"> * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<span class="cm"> * the License. You may obtain a copy of the License at</span>
<span class="cm"> * http://www.mozilla.org/MPL/</span>
<span class="cm"> *</span>
<span class="cm"> * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<span class="cm"> * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<span class="cm"> * for the specific language governing rights and limitations under the</span>
<span class="cm"> * License.</span>
<span class="cm"> *</span>
<span class="cm"> * The Original Code is mozilla.org code.</span>
<span class="cm"> *</span>
<span class="cm"> * The Initial Developer of the Original Code is</span>
<span class="cm"> * the Mozilla Foundation.</span>
<span class="cm"> * Portions created by the Initial Developer are Copyright (C) 2010</span>
<span class="cm"> * the Initial Developer. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Contributor(s):</span>
<span class="cm"> *  Justin Dolske &lt;dolske@mozilla.com&gt; (original author)</span>
<span class="cm"> *  David Dahl &lt;ddahl@mozilla.com&gt;</span>
<span class="cm"> *  Sergio Ruiz &lt;invi@pidgeonpg.org&gt; [1]</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, the contents of this file may be used under the terms of</span>
<span class="cm"> * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<span class="cm"> * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<span class="cm"> * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<span class="cm"> * of those above. If you wish to allow use of your version of this file only</span>
<span class="cm"> * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<span class="cm"> * use your version of this file under the terms of the MPL, indicate your</span>
<span class="cm"> * decision by deleting the provisions above and replace them with the notice</span>
<span class="cm"> * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<span class="cm"> * the provisions above, a recipient may use your version of this file under</span>
<span class="cm"> * the terms of any one of the MPL, the GPL or the LGPL.</span>
<span class="cm"> *</span>
<span class="cm"> * ***** END LICENSE BLOCK ***** */</span>

<span class="cm">/**</span>
<span class="cm"> * NOTES:</span>
<span class="cm"> *</span>
<span class="cm"> * The WeaveCrypto object in this file was originally pulled from hg.mozilla.org</span>
<span class="cm"> *</span>
<span class="cm"> * http://hg.mozilla.org/mozilla-central/ \</span>
<span class="cm"> * raw-file/d0c40fc38702/services/crypto/modules/WeaveCrypto.js</span>
<span class="cm"> *</span>
<span class="cm"> * WeaveCrypto&#39;s API as it was released in Firefox 4 was reduced in scope due</span>
<span class="cm"> * to Sync&#39;s move to J-Pake, hence the need for this more complete version.</span>
<span class="cm"> *</span>
<span class="cm"> * This version has the additional APIs &#39;sign&#39; and &#39;verify&#39; and has been</span>
<span class="cm"> * edited for use in a ChromeWorker.</span>
<span class="cm"> *</span>
<span class="cm"> * [1] This version has been modified for direct public and private key import </span>
<span class="cm"> * in DER format to support sign, verify, encrypt and decrypt in</span>
<span class="cm"> * such case. Also DSA and ElGamal key generation has been added. </span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">DEBUG</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">PUB_ALGO</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">RSA</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> 
  <span class="nx">RSA_E</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">RSA_S</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nx">ELGAMAL_E</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
  <span class="nx">DSA</span><span class="o">:</span> <span class="mi">17</span><span class="p">,</span> 
  <span class="nx">ECDH</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
  <span class="nx">ECDSA</span><span class="o">:</span> <span class="mi">19</span><span class="p">,</span>
  <span class="nx">ELGAMAL</span><span class="o">:</span> <span class="mi">20</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">log</span><span class="p">(</span><span class="nx">aMessage</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">DEBUG</span><span class="p">){</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">_msg</span> <span class="o">=</span> <span class="s2">&quot;domcrypt_worker: &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">aMessage</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">;</span>
  <span class="nx">dump</span><span class="p">(</span><span class="nx">_msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">GENERATE_KEYPAIR</span>  <span class="o">=</span> <span class="s2">&quot;generateKeypair&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">GENERATE_RANDOM</span>   <span class="o">=</span> <span class="s2">&quot;generateRandom&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">ENCRYPT</span>           <span class="o">=</span> <span class="s2">&quot;encrypt&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">DECRYPT</span>           <span class="o">=</span> <span class="s2">&quot;decrypt&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">SIGN</span>              <span class="o">=</span> <span class="s2">&quot;sign&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">VERIFY</span>            <span class="o">=</span> <span class="s2">&quot;verify&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">GENERATE_SYM_KEY</span>  <span class="o">=</span> <span class="s2">&quot;generateSymKey&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">SYM_ENCRYPT</span>       <span class="o">=</span> <span class="s2">&quot;symEncrypt&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">SYM_DECRYPT</span>       <span class="o">=</span> <span class="s2">&quot;symDecrypt&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">WRAP_SYM_KEY</span>      <span class="o">=</span> <span class="s2">&quot;wrapSymKey&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">VERIFY_PASSPHRASE</span> <span class="o">=</span> <span class="s2">&quot;verifyPassphrase&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">SHUTDOWN</span>          <span class="o">=</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">INITIALIZE</span>        <span class="o">=</span> <span class="s2">&quot;init&quot;</span><span class="p">;</span>


<span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">aEvent</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">INITIALIZE</span><span class="o">:</span>
      <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">initNSS</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">nssPath</span><span class="p">);</span>
      <span class="nx">DEBUG</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">debug</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">GENERATE_KEYPAIR</span><span class="o">:</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">WeaveCryptoWrapper</span><span class="p">.</span><span class="nx">generateKeypair</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">keyType</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">keypairBits</span><span class="p">);</span>
      <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">keypairData</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;keypairGenerated&quot;</span> <span class="p">}));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">GENERATE_RANDOM</span><span class="o">:</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">WeaveCryptoWrapper</span><span class="p">.</span><span class="nx">generateRandom</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">aLength</span><span class="p">);</span>
      <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">randomBytes</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;randomGenerated&quot;</span> <span class="p">}));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">ENCRYPT</span><span class="o">:</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">WeaveCryptoWrapper</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">plainText</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">pubKey</span><span class="p">);</span>
      <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">cipherMessage</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;dataEncrypted&quot;</span> <span class="p">}));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">DECRYPT</span><span class="o">:</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">WeaveCryptoWrapper</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">aCipherMessage</span><span class="p">,</span>
                                          <span class="nx">data</span><span class="p">.</span><span class="nx">derSecKey</span><span class="p">);</span>
    
      <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">plainText</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;dataDecrypted&quot;</span> <span class="p">}));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">SIGN</span><span class="o">:</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">WeaveCryptoWrapper</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span>
                                       <span class="nx">data</span><span class="p">.</span><span class="nx">derSecKey</span><span class="p">,</span>
                                       <span class="nx">data</span><span class="p">.</span><span class="nx">derPubKey</span><span class="p">);</span>
    
      <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">signature</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;messageSigned&quot;</span> <span class="p">}));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">VERIFY</span><span class="o">:</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">WeaveCryptoWrapper</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span>
                                         <span class="nx">data</span><span class="p">.</span><span class="nx">signature</span><span class="p">,</span>
                                         <span class="nx">data</span><span class="p">.</span><span class="nx">pubKey</span><span class="p">);</span>
    
      <span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">verification</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;messageVerified&quot;</span> <span class="p">}));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">SHUTDOWN</span><span class="o">:</span>
      <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">();</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * WeaveCryptoWrapper</span>
<span class="cm"> *</span>
<span class="cm"> * Wrap the WeaveCrypto API in a more elegant way. This is very similar to the</span>
<span class="cm"> * original DOMCrypt extension code</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">WeaveCryptoWrapper</span> <span class="o">=</span> <span class="p">{</span>

  <span class="cm">/**</span>
<span class="cm">   * generateKeypair</span>
<span class="cm">   *</span>
<span class="cm">   * Create a KeyPair for general purpose </span>
<span class="cm">   *</span>
<span class="cm">   * @param int Type of Key algorithm </span>
<span class="cm">   *        int Key length in bits</span>
<span class="cm">   * @returns object</span>
<span class="cm">   *          The object returned looks like:</span>
<span class="cm">   *          { action:  &quot;keypairGenerated&quot;,</span>
<span class="cm">   *            privKey: &lt;PRIVATE KEY&gt;,</span>
<span class="cm">   *            created: &lt;DATE CREATED&gt;</span>
<span class="cm">   *          }</span>
<span class="cm">   */</span>
  <span class="nx">generateKeypair</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">WCW_generateKeypair</span><span class="p">(</span><span class="nx">keyType</span><span class="p">,</span> <span class="nx">keypairBits</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">privOut</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">generateKeypair</span><span class="p">(</span><span class="nx">keyType</span><span class="p">,</span> <span class="nx">keypairBits</span><span class="p">,</span> <span class="nx">privOut</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;keypairGenerated&quot;</span><span class="p">,</span>
                      <span class="nx">privKey</span><span class="o">:</span> <span class="nx">privOut</span><span class="p">,</span>
                      <span class="nx">created</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
                    <span class="p">};</span>
      <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
      <span class="k">throw</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">   * generateRandom</span>
<span class="cm">   *</span>
<span class="cm">   * Create a random bytes</span>
<span class="cm">   *</span>
<span class="cm">   * @param int Numbes of random bytes to create</span>
<span class="cm">   * @returns object</span>
<span class="cm">   *          The object returned looks like:</span>
<span class="cm">   *          { action:  &quot;randomGenerated&quot;,</span>
<span class="cm">   *            randomBytes: &lt;STRING OF RANDOM BYTES&gt;</span>
<span class="cm">   *          }</span>
<span class="cm">   */</span>
  <span class="nx">generateRandom</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">WCW_generateRandom</span><span class="p">(</span><span class="nx">nbytes</span><span class="p">)</span>
  <span class="p">{</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">randomBytes</span> <span class="o">=</span> <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">generateRandomBytes</span><span class="p">(</span><span class="nx">nbytes</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;randomGenerated&quot;</span><span class="p">,</span>
                      <span class="nx">randomBytes</span><span class="o">:</span> <span class="nx">randomBytes</span>
                    <span class="p">};</span>
      <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
      <span class="k">throw</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">   * encrypt</span>
<span class="cm">   *</span>
<span class="cm">   * Encrypt data with a public key</span>
<span class="cm">   *</span>
<span class="cm">   * @param string aSessionkey</span>
<span class="cm">   *        The base64 session key data that will be encrypted</span>
<span class="cm">   * @param string aPublicKey</span>
<span class="cm">   *        The recipient&#39;s DER base64 encoded public key</span>
<span class="cm">   * @returns Object</span>
<span class="cm">   *          A &#39;message&#39; object:</span>
<span class="cm">   *          { content:    &lt;ENCRYPTED_STRING&gt;,</span>
<span class="cm">   *            pubKey:     &lt;RECIPIENT PUB_KEY&gt;,</span>
<span class="cm">   *            wrappedKey: &lt;WRAPPED SYM_KEY&gt;,</span>
<span class="cm">   *            iv:         &lt;INITIALIZATION VECTOR&gt;</span>
<span class="cm">   *          }</span>
<span class="cm">   */</span>
  <span class="nx">encrypt</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">WCW_encrypt</span><span class="p">(</span><span class="nx">aSessionkey</span><span class="p">,</span> <span class="nx">aPublicKey</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aSessionkey</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">aPublicKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Missing Arguments: aSessionkey and aPublicKey are required&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">encryptedSessionkey</span> <span class="o">=</span> <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">aSessionkey</span><span class="p">,</span> <span class="nx">aPublicKey</span><span class="p">);</span>
      <span class="k">return</span>  <span class="nx">encryptedSessionkey</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">   * decrypt</span>
<span class="cm">   *</span>
<span class="cm">   * Decrypt encrypted data with a private key</span>
<span class="cm">   *</span>
<span class="cm">   * @param string aSessionkey</span>
<span class="cm">   *        The base64 encrypted session key</span>
<span class="cm">   * @param string aPrivateKey</span>
<span class="cm">   *        The base64 encoded private key string</span>
<span class="cm">   * @returns string</span>
<span class="cm">   *          The decrypted message in base64</span>
<span class="cm">   */</span>
  <span class="nx">decrypt</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">WCW_decrypt</span><span class="p">(</span><span class="nx">aSessionkey</span><span class="p">,</span> <span class="nx">aPrivateKey</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">decrypted</span> <span class="o">=</span> <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">aSessionkey</span><span class="p">,</span> <span class="nx">aPrivateKey</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">decrypted</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
      <span class="k">throw</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">   * Cryptographically sign a message</span>
<span class="cm">   *</span>
<span class="cm">   * @param string aHash</span>
<span class="cm">   *        A base64 signature data hash of the message</span>
<span class="cm">   * @param string aPrivateKey</span>
<span class="cm">   *        The sender&#39;s base64 DER encoded private key</span>
<span class="cm">   * @param string aPublicKey</span>
<span class="cm">   *        The sender&#39;s base64 DER encoded public key</span>
<span class="cm">   */</span>
  <span class="nx">sign</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">WCW_sign</span><span class="p">(</span><span class="nx">aHash</span><span class="p">,</span> <span class="nx">aPrivateKey</span><span class="p">,</span> <span class="nx">aPublicKey</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">signature</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">signature</span> <span class="o">=</span> <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">aPrivateKey</span><span class="p">,</span> <span class="nx">aPublicKey</span><span class="p">,</span> <span class="nx">aHash</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">signature</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="cm">/**</span>
<span class="cm">   * Verify a signature was created by the sender</span>
<span class="cm">   *</span>
<span class="cm">   * @param string aData</span>
<span class="cm">   *        A base64 signature data </span>
<span class="cm">   * @param string aSignature</span>
<span class="cm">   *        A base64 encoded signature string</span>
<span class="cm">   * @param string aPublicKey</span>
<span class="cm">   *        The sender&#39;s base 64 DER encoded public key</span>
<span class="cm">   * @returns boolean</span>
<span class="cm">   */</span>
  <span class="nx">verify</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">WCW_verify</span><span class="p">(</span><span class="nx">aData</span><span class="p">,</span> <span class="nx">aSignature</span><span class="p">,</span> <span class="nx">aPublicKey</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">WeaveCrypto</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">aPublicKey</span><span class="p">,</span> <span class="nx">aSignature</span><span class="p">,</span> <span class="nx">aData</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * The WeaveCrypto changes I have made are minimal:</span>
<span class="cm"> * 1. Removed any calls into Cc/Ci/Cr, etc.</span>
<span class="cm"> * 2. added WeaveCrypto.sign() (PK11_Sign)</span>
<span class="cm"> * 3. added WeaveCrypto.verify() (PK11_Verify)</span>
<span class="cm"> *</span>
<span class="cm"> * WeaveCrypto (js-ctypes iteration) was coded and reviewed in this bug:</span>
<span class="cm"> * https://bugzilla.mozilla.org/show_bug.cgi?id=513798</span>
<span class="cm"> *</span>
<span class="cm"> */</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>http://mxr.mozilla.org/mozilla-central/source/security/nss/lib/util/secoidt.h#318
recommended EC algs: http://www.nsa.gov/business/programs/elliptic_curve.shtml
http://mxr.mozilla.org/mozilla-central/source/security/nss/lib/util/secoidt.h#346</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">WeaveCrypto</span> <span class="o">=</span> <span class="p">{</span>

  <span class="nx">debugEnabled</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">nss</span>          <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">nss_t</span>        <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">log</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">debugEnabled</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="nx">dump</span><span class="p">(</span><span class="s2">&quot;WeaveCrypto: &quot;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">shutdown</span> <span class="o">:</span> <span class="kd">function</span> <span class="nx">WC_shutdown</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;closing nsslib&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nsslib</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="nx">fullPathToLib</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

  <span class="nx">initNSS</span> <span class="o">:</span> <span class="kd">function</span> <span class="nx">WC_initNSS</span><span class="p">(</span><span class="nx">aNSSPath</span><span class="p">,</span> <span class="nx">debugEnabled</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Open the NSS library.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">fullPathToLib</span> <span class="o">=</span> <span class="nx">aNSSPath</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">debugEnabled</span> <span class="o">=</span> <span class="nx">debugEnabled</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>XXX really want to be able to pass specific dlopen flags here.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">nsslib</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fullPathToLib</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nsslib</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Initializing NSS types and function declarations...&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>nsprpub/pr/include/prtypes.h#435
typedef PRIntn PRBool; --> int</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PRBool</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/util/seccomon.h#91
typedef enum</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/softoken/secmodt.h#59
typedef struct PK11SlotInfoStr PK11SlotInfo; (defined in secmodti.h)</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">void_t</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/util/pkcs11t.h</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CK_MECHANISM_TYPE</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_long</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CK_ATTRIBUTE_TYPE</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_long</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CK_KEY_TYPE</span>       <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_long</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CK_OBJECT_HANDLE</span>  <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_long</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/util/seccomon.h#64
typedef enum</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItemType</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>SECItemType enum values...</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SIBUFFER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Needed for SECKEYPrivateKey struct def'n, but I don't think we need to actually access it.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">void_t</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keythi.h#45
typedef enum</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">KeyType</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/softoken/secmodt.h#201
typedef PRUint32 PK11AttrFlags;</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11AttrFlags</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/util/seccomon.h#83
typedef struct SECItemStr SECItem; --> SECItemStr defined right below it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;SECItem&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItemType</span> <span class="p">},</span>
                  <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span> <span class="p">},</span>
                  <span class="p">{</span> <span class="nx">len</span> <span class="o">:</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span> <span class="p">}]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/softoken/secmodt.h#65
typedef struct PK11RSAGenParamsStr --> def'n on line 139</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11RSAGenParams</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;PK11RSAGenParams&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">keySizeInBits</span><span class="o">:</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span> <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">pe</span> <span class="o">:</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_long</span> <span class="p">}]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/softoken/secmodt.h#65
typedef struct PK11RSAGenParamsStr --> def'n on line 132
struct SECKEYDHParamsStr {
    PLArenaPool * arena;
    SECItem prime; /* p <em>/
    SECItem base; /</em> g */</p></div></div><div class="code"><div class="wrapper">    <span class="c1">// };</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYDHParams</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;SECKEYDHParams&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">arena</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span><span class="p">.</span><span class="nx">ptr</span>  <span class="p">},</span>
                         <span class="p">{</span> <span class="nx">prime</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">},</span>
                         <span class="p">{</span> <span class="nx">base</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">},]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keythi.h#233
typedef struct SECKEYPrivateKeyStr SECKEYPrivateKey; --> def'n right above it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;SECKEYPrivateKey&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">arena</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span><span class="p">.</span><span class="nx">ptr</span>  <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">keyType</span><span class="o">:</span>      <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">KeyType</span>          <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">pkcs11Slot</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span><span class="p">.</span><span class="nx">ptr</span> <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">pkcs11ID</span><span class="o">:</span>     <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CK_OBJECT_HANDLE</span> <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">pkcs11IsTemp</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PRBool</span>           <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">wincx</span><span class="o">:</span>        <span class="nx">ctypes</span><span class="p">.</span><span class="nx">voidptr_t</span>            <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">staticflags</span><span class="o">:</span>  <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span>         <span class="p">}]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keythi.h#78
typedef struct SECKEYRSAPublicKeyStr --> def'n right above it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYRSAPublicKey</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;SECKEYRSAPublicKey&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">arena</span><span class="o">:</span>          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span><span class="p">.</span><span class="nx">ptr</span> <span class="p">},</span>
                             <span class="p">{</span> <span class="nx">modulus</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">},</span>
                             <span class="p">{</span> <span class="nx">publicExponent</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">}]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keythi.h#189
typedef struct SECKEYPublicKeyStr SECKEYPublicKey; --> def'n right above it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;SECKEYPublicKey&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">arena</span><span class="o">:</span>      <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span><span class="p">.</span><span class="nx">ptr</span>    <span class="p">},</span>
                          <span class="p">{</span> <span class="nx">keyType</span><span class="o">:</span>    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">KeyType</span>            <span class="p">},</span>
                          <span class="p">{</span> <span class="nx">pkcs11Slot</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span><span class="p">.</span><span class="nx">ptr</span>   <span class="p">},</span>
                          <span class="p">{</span> <span class="nx">pkcs11ID</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CK_OBJECT_HANDLE</span>   <span class="p">},</span>
                          <span class="p">{</span> <span class="nx">rsa</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYRSAPublicKey</span> <span class="p">}</span> <span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/util/secoidt.h#52
typedef struct SECAlgorithmIDStr --> def'n right below it</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECAlgorithmID</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;SECAlgorithmID&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">algorithm</span><span class="o">:</span>  <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span> <span class="p">},</span>
                         <span class="p">{</span> <span class="nx">parameters</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span> <span class="p">}]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/certdb/certt.h#98
typedef struct CERTSubjectPublicKeyInfoStrA --> def'n on line 160</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CERTSubjectPublicKeyInfo</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;CERTSubjectPublicKeyInfo&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">arena</span><span class="o">:</span>            <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span><span class="p">.</span><span class="nx">ptr</span> <span class="p">},</span>
                                   <span class="p">{</span> <span class="nx">algorithm</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECAlgorithmID</span>  <span class="p">},</span>
                                   <span class="p">{</span> <span class="nx">subjectPublicKey</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">}]);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGParams</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;PQGParams&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">arena</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span><span class="p">.</span><span class="nx">ptr</span> <span class="p">},</span>
                         <span class="p">{</span> <span class="nx">prime</span><span class="o">:</span>        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">},</span>
                         <span class="p">{</span> <span class="nx">subPrime</span><span class="o">:</span>     <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">},</span>
                         <span class="p">{</span> <span class="nx">base</span><span class="o">:</span>         <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span>         <span class="p">},]);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGVerify</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">StructType</span><span class="p">(</span>
      <span class="s2">&quot;PQGVerify&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nx">arena</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PLArenaPool</span><span class="p">.</span><span class="nx">ptr</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="nx">counter</span><span class="o">:</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">},</span>
                    <span class="p">{</span> <span class="nx">seed</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="nx">h</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span> <span class="p">}]);</span>


    <span class="cm">/* XXX chrisk: this needs to be expanded to hold j and validationParms (RFC2459 7.3.2) */</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/util/pkcs11t.h</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">CKM_RSA_PKCS_KEY_PAIR_GEN</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">CKM_DH_PKCS_KEY_PAIR_GEN</span>  <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">CKM_DSA_KEY_PAIR_GEN</span>      <span class="o">=</span> <span class="mh">0x0010</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/softoken/secmodt.h</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ATTR_SESSION</span>   <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ATTR_PUBLIC</span>    <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ATTR_SENSITIVE</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ATTR_INSENSITIVE</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/pk11wrap/pk11pub.h#286
SECStatus PK11_GenerateRandom(unsigned char *data,int len);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GenerateRandom</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_GenerateRandom&quot;</span><span class="p">,</span>
                                                  <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span>
                                                  <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/pk11wrap/pk11pub.h#74
PK11SlotInfo *PK11_GetInternalSlot(void);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GetInternalSlot</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_GetInternalSlot&quot;</span><span class="p">,</span>
                                                   <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/pk11wrap/pk11pub.h#73
PK11SlotInfo *PK11_GetInternalKeySlot(void);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GetInternalKeySlot</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_GetInternalKeySlot&quot;</span><span class="p">,</span>
                                                      <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PrivDecryptPKCS1</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_PrivDecryptPKCS1&quot;</span><span class="p">,</span> 
                                                    <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span> 
                                                    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> 
                                                    <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                                    <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                                    <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">);</span>

    <span class="cm">/* The encrypt function that complements the above decrypt function. */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PubEncryptPKCS1</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span>
          <span class="s2">&quot;PK11_PubEncryptPKCS1&quot;</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span> 
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">voidptr_t</span>
    <span class="p">);</span>

    <span class="cm">/* Generate PQGParams and PQGVerify structs.</span>
<span class="cm">     * Length of seed and length of h both equal length of P. </span>
<span class="cm">     * All lengths are specified by &quot;j&quot;, according to the table above.</span>
<span class="cm">     */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PQG_ParamGen</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span>
          <span class="s2">&quot;PK11_PQG_ParamGen&quot;</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGParams</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGVerify</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">ptr</span>
    <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extern SECStatus PK11<em>PQG</em>GetPrimeFromParams(const PQGParams *params,
              SECItem * prime);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PQG_GetPrimeFromParams</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span>
          <span class="s2">&quot;PK11_PQG_GetPrimeFromParams&quot;</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span> 
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGParams</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span>
    <span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PubDecryptRaw</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span>
          <span class="s2">&quot;PK11_PubDecryptRaw&quot;</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span> 
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span>
    <span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ImportDERPrivateKeyInfoAndReturnKey</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_ImportDERPrivateKeyInfoAndReturnKey&quot;</span><span class="p">,</span> 
          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PRBool</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PRBool</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span><span class="p">,</span>  
          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">ptr</span>
    <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>SIGNING API //////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/pk11wrap/pk11pub.h#682
int PK11_SignatureLength(SECKEYPrivateKey *key);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_SignatureLen</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_SignatureLen&quot;</span><span class="p">,</span>
                                                <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span>
                                                <span class="nx">ctypes</span><span class="p">.</span><span class="kr">int</span><span class="p">,</span>
                                                <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/pk11wrap/pk11pub.h#684
SECStatus PK11_Sign(SECKEYPrivateKey *key, SECItem *sig, SECItem *hash);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_Sign</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_Sign&quot;</span><span class="p">,</span>
                                        <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/pk11wrap/pk11pub.h#687
SECStatus PK11_Verify(SECKEYPublicKey *key, SECItem *sig, SECItem *hash, void *wincx);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_Verify</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_Verify&quot;</span><span class="p">,</span>
                                          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span>
                                          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span>
                                          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                          <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                          <span class="nx">ctypes</span><span class="p">.</span><span class="nx">voidptr_t</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>END SIGNING API
////////////////////////////////////////////////////////////////////////</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/pk11wrap/pk11pub.h#507
SECKEYPrivateKey <em>PK11_GenerateKeyPairWithFlags(PK11SlotInfo *slot,
                                                CK_MECHANISM_TYPE type, void *param, SECKEYPublicKey *</em>pubk,
                                                PK11AttrFlags attrFlags, void *wincx);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GenerateKeyPairWithFlags</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_GenerateKeyPairWithFlags&quot;</span><span class="p">,</span>
                                                            <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                                            <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CK_MECHANISM_TYPE</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">voidptr_t</span><span class="p">,</span>
                                                            <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11AttrFlags</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">voidptr_t</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/pk11wrap/pk11pub.h#466
SECStatus PK11_SetPrivateKeyNickname(SECKEYPrivateKey *privKey, const char *nickname);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_SetPrivateKeyNickname</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_SetPrivateKeyNickname&quot;</span><span class="p">,</span>
                                                         <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span>
                                                         <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="kr">char</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keyhi.h#159
SECItem* SECKEY_EncodeDERSubjectPublicKeyInfo(SECKEYPublicKey *pubk);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_EncodeDERSubjectPublicKeyInfo</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;SECKEY_EncodeDERSubjectPublicKeyInfo&quot;</span><span class="p">,</span>
                                                                   <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                                                   <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keyhi.h#165
CERTSubjectPublicKeyInfo * SECKEY_DecodeDERSubjectPublicKeyInfo(SECItem *spkider);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DecodeDERSubjectPublicKeyInfo</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;SECKEY_DecodeDERSubjectPublicKeyInfo&quot;</span><span class="p">,</span>
                                                                   <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CERTSubjectPublicKeyInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                                                   <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keyhi.h#179
SECKEYPublicKey * SECKEY_ExtractPublicKey(CERTSubjectPublicKeyInfo *);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_ExtractPublicKey</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;SECKEY_ExtractPublicKey&quot;</span><span class="p">,</span>
                                                      <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">,</span>
                                                      <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CERTSubjectPublicKeyInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/pk11wrap/pk11pub.h#70
void PK11_FreeSlot(PK11SlotInfo *slot);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_FreeSlot</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_FreeSlot&quot;</span><span class="p">,</span>
                                            <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">void_t</span><span class="p">,</span>
                                            <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11SlotInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keyhi.h#193
extern void SECKEY_DestroyPublicKey(SECKEYPublicKey *key);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroyPublicKey</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;SECKEY_DestroyPublicKey&quot;</span><span class="p">,</span>
                                                      <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">void_t</span><span class="p">,</span>
                                                      <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keyhi.h#186
extern void SECKEY_DestroyPrivateKey(SECKEYPrivateKey *key);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroyPrivateKey</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;SECKEY_DestroyPrivateKey&quot;</span><span class="p">,</span>
                                                       <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">void_t</span><span class="p">,</span>
                                                       <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Creates a PublicKey from its DER encoding.</span>
<span class="cm">     * Currently only supports RSA and DSA keys.</span>
<span class="cm">    */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_PublicKeyStrengthInBits</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;SECKEY_PublicKeyStrengthInBits&quot;</span><span class="p">,</span> 
                                                             <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_int</span><span class="p">,</span> 
                                                             <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>security/nss/lib/cryptohi/keyhi.h#58
extern void SECKEY_DestroySubjectPublicKeyInfo(CERTSubjectPublicKeyInfo *spki);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroySubjectPublicKeyInfo</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;SECKEY_DestroySubjectPublicKeyInfo&quot;</span><span class="p">,</span>
                                                                 <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">void_t</span><span class="p">,</span>
                                                                 <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">CERTSubjectPublicKeyInfo</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>SECStatus PK11<em>ReadRawAttribute(PK11ObjectType type, void *object,
CK</em>ATTRIBUTE_TYPE attr, SECItem *item);</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ReadRawAttribute</span> <span class="o">=</span> <span class="nx">nsslib</span><span class="p">.</span><span class="nx">declare</span><span class="p">(</span><span class="s2">&quot;PK11_ReadRawAttribute&quot;</span><span class="p">,</span>
                                                    <span class="nx">ctypes</span><span class="p">.</span><span class="nx">default_abi</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span> 
                                                    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECStatus</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">voidptr_t</span><span class="p">,</span> 
                                                    <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11AttrFlags</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">.</span><span class="nx">ptr</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">sign</span> <span class="o">:</span> <span class="kd">function</span> <span class="nx">_sign</span><span class="p">(</span><span class="nx">aDerPrivKey</span><span class="p">,</span> <span class="nx">aDerPubKey</span><span class="p">,</span> <span class="nx">aHash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;sign() called&quot;</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">slot</span><span class="p">,</span> <span class="nx">hash</span><span class="p">,</span> <span class="nx">sig</span><span class="p">;</span>

    <span class="nx">slot</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GetInternalSlot</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t get internal slot&quot;</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">derPrivKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aDerPrivKey</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">derPubKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aDerPubKey</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="nx">privKey</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">();</span>
    <span class="nx">hash</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aHash</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">sig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">rv</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ImportDERPrivateKeyInfoAndReturnKey</span><span class="p">(</span><span class="nx">slot</span><span class="p">,</span> 
                    <span class="nx">derPrivKey</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">derPubKey</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="kc">false</span><span class="p">,</span> 
                    <span class="kc">true</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x7fffffff</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">privKey</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">privKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span> 
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;sign error: Could not import DER private key&quot;</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">sigLen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_SignatureLen</span><span class="p">(</span><span class="nx">privKey</span><span class="p">);</span>
    <span class="nx">sig</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">sigLen</span><span class="p">;</span>
    <span class="nx">sig</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="nx">sigLen</span><span class="p">)();</span>

    <span class="kd">let</span> <span class="nx">status</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_Sign</span><span class="p">(</span><span class="nx">privKey</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Could not sign message&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">encodeBase64</span><span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">verify</span> <span class="o">:</span> <span class="kd">function</span> <span class="nx">_verify</span><span class="p">(</span><span class="nx">aDerPubKey</span><span class="p">,</span> <span class="nx">aSignature</span><span class="p">,</span> <span class="nx">aHash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;verify() called&quot;</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">derPubKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aDerPubKey</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">pubKeyInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DecodeDERSubjectPublicKeyInfo</span><span class="p">(</span><span class="nx">derPubKey</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pubKeyInfo</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;SECKEY_DecodeDERSubjectPublicKeyInfo failed&quot;</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">pubKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_ExtractPublicKey</span><span class="p">(</span><span class="nx">pubKeyInfo</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">pubKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;SECKEY_ExtractPublicKey failed&quot;</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">sig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aSignature</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">hash</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aHash</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">status</span> <span class="o">=</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_Verify</span><span class="p">(</span><span class="nx">pubKey</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="kc">null</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;verify return &quot;</span> <span class="o">+</span> <span class="nx">status</span><span class="p">);</span> 

    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">generateKeypair</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keyType</span><span class="p">,</span> <span class="nx">keypairBits</span><span class="p">,</span> <span class="nx">out_fields</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;generateKeypair() called. keytype(&quot;</span><span class="o">+</span> <span class="nx">keyType</span> <span class="o">+</span> <span class="s2">&quot;) keybits(&quot;</span><span class="o">+</span> <span class="nx">keypairBits</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">pubKey</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">slot</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Attributes for the private key. We're just going to wrap and extract the
value, so they're not critical. The _PUBLIC attribute just indicates the
object can be accessed without being logged into the token.</p></div></div><div class="code"><div class="wrapper">      <span class="kd">let</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">genType</span><span class="p">,</span> <span class="nx">rc</span><span class="p">;</span>
      <span class="k">switch</span><span class="p">(</span><span class="nx">keyType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">PUB_ALGO</span><span class="p">.</span><span class="nx">RSA</span><span class="o">:</span>
          <span class="kd">let</span> <span class="nx">rsaParams</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PK11RSAGenParams</span><span class="p">();</span>
          <span class="nx">rsaParams</span><span class="p">.</span><span class="nx">keySizeInBits</span> <span class="o">=</span> <span class="nx">keypairBits</span><span class="p">;</span> <span class="c1">// 1024, 2048, etc.</span>
          <span class="nx">rsaParams</span><span class="p">.</span><span class="nx">pe</span> <span class="o">=</span> <span class="mi">65537</span><span class="p">;</span>                  <span class="c1">// public exponent.</span>
          <span class="nx">params</span> <span class="o">=</span> <span class="nx">rsaParams</span><span class="p">.</span><span class="nx">address</span><span class="p">();</span>
          <span class="nx">genType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">CKM_RSA_PKCS_KEY_PAIR_GEN</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nx">PUB_ALGO</span><span class="p">.</span><span class="nx">DSA</span><span class="o">:</span>
          <span class="kd">var</span> <span class="nx">pqgparams</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGParams</span><span class="p">.</span><span class="nx">ptr</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">pqgverify</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGVerify</span><span class="p">.</span><span class="nx">ptr</span><span class="p">();</span>
          <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PQG_ParamGen</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nx">pqgparams</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">pqgverify</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
          <span class="nx">params</span> <span class="o">=</span> <span class="nx">pqgparams</span><span class="p">;</span>
          <span class="nx">genType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">CKM_DSA_KEY_PAIR_GEN</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nx">PUB_ALGO</span><span class="p">.</span><span class="nx">ELGAMAL_E</span><span class="o">:</span>
          <span class="kd">var</span> <span class="nx">dhParams</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYDHParams</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">pqgparams</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGParams</span><span class="p">.</span><span class="nx">ptr</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">pqgverify</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">PQGVerify</span><span class="p">.</span><span class="nx">ptr</span><span class="p">();</span>
          <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PQG_ParamGen</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nx">pqgparams</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">pqgverify</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
          <span class="kd">var</span> <span class="nx">prime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
          <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PQG_GetPrimeFromParams</span><span class="p">(</span><span class="nx">pqgparams</span><span class="p">,</span> <span class="nx">prime</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
          <span class="nx">dhParams</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
          <span class="nx">dhParams</span><span class="p">.</span><span class="nx">prime</span> <span class="o">=</span> <span class="nx">prime</span><span class="p">;</span>
          <span class="nx">params</span> <span class="o">=</span> <span class="nx">dhParams</span><span class="p">.</span><span class="nx">address</span><span class="p">();</span>
          <span class="nx">genType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">CKM_DH_PKCS_KEY_PAIR_GEN</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unkown key type algo: &quot;</span> <span class="o">+</span> <span class="nx">keyType</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">slot</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GetInternalSlot</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t get internal slot&quot;</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">attrFlags</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ATTR_SESSION</span> <span class="o">|</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ATTR_PUBLIC</span> <span class="o">|</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ATTR_INSENSITIVE</span><span class="p">);</span>
      <span class="nx">pubKey</span>  <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPublicKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate the keypair.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">privKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GenerateKeyPairWithFlags</span><span class="p">(</span><span class="nx">slot</span><span class="p">,</span>
                                                       <span class="nx">genType</span><span class="p">,</span>
                                                       <span class="nx">params</span><span class="p">,</span>
                                                       <span class="nx">pubKey</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span>
                                                       <span class="nx">attrFlags</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">privKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;keypair generation failed&quot;</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_SetPrivateKeyNickname</span><span class="p">(</span><span class="nx">privKey</span><span class="p">,</span> <span class="s2">&quot;Weave User PrivKey&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;key nickname failed&quot;</span><span class="p">);</span>

      <span class="k">try</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use a buffer to hold the wrapped key. NSS says about 1200 bytes for
a 2048-bit RSA key, so a 4096 byte buffer should be plenty.</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">CKA_MODULUS</span>          <span class="o">=</span> <span class="mh">0x00000120</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_MODULUS_BITS</span>     <span class="o">=</span> <span class="mh">0x00000121</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_PUBLIC_EXPONENT</span>  <span class="o">=</span> <span class="mh">0x00000122</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_PRIVATE_EXPONENT</span> <span class="o">=</span> <span class="mh">0x00000123</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_PRIME_1</span>          <span class="o">=</span> <span class="mh">0x00000124</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_PRIME_2</span>          <span class="o">=</span> <span class="mh">0x00000125</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_EXPONENT_1</span>       <span class="o">=</span> <span class="mh">0x00000126</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_EXPONENT_2</span>       <span class="o">=</span> <span class="mh">0x00000127</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_COEFFICIENT</span>      <span class="o">=</span> <span class="mh">0x00000128</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_PRIME</span>            <span class="o">=</span> <span class="mh">0x00000130</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_SUBPRIME</span>         <span class="o">=</span> <span class="mh">0x00000131</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_BASE</span>             <span class="o">=</span> <span class="mh">0x00000132</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_VALUE</span>            <span class="o">=</span> <span class="mh">0x00000011</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_DERIVE</span>           <span class="o">=</span> <span class="mh">0x0000010C</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">CKA_NETSCAPE_DB</span>      <span class="o">=</span> <span class="mh">0xD5A0DB00</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">attrtype</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use a buffer to hold the wrapped key. NSS says about 1200 bytes for
a 2048-bit RSA key, so a 4096 byte buffer should be plenty.</p></div></div><div class="code"><div class="wrapper">          <span class="kd">let</span> <span class="nx">keyData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)();</span>
          <span class="kd">let</span> <span class="nx">outData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SIBUFFER</span><span class="p">,</span> <span class="nx">keyData</span><span class="p">,</span> <span class="nx">keyData</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
          <span class="kd">let</span> <span class="nx">rc</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ReadRawAttribute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">attrtype</span><span class="p">,</span> <span class="nx">outData</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
          <span class="kd">let</span> <span class="nx">intData</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">cast</span><span class="p">(</span><span class="nx">outData</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">uint8_t</span><span class="p">.</span><span class="nx">array</span><span class="p">(</span><span class="nx">outData</span><span class="p">.</span><span class="nx">len</span><span class="p">).</span><span class="nx">ptr</span><span class="p">).</span><span class="nx">contents</span><span class="p">;</span>
          <span class="kd">let</span> <span class="nx">expanded</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">outData</span><span class="p">.</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
            <span class="nx">expanded</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">intData</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
          <span class="k">return</span> <span class="nx">btoa</span><span class="p">(</span><span class="nx">expanded</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">switch</span><span class="p">(</span><span class="nx">keyType</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="nx">PUB_ALGO</span><span class="p">.</span><span class="nx">RSA</span><span class="o">:</span> 
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_MODULUS</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_PUBLIC_EXPONENT</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_PRIVATE_EXPONENT</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">q</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_PRIME_1</span><span class="p">)</span>  
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_PRIME_2</span><span class="p">)</span> 
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">u</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_COEFFICIENT</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="nx">PUB_ALGO</span><span class="p">.</span><span class="nx">ELGAMAL_E</span><span class="o">:</span> <span class="c1">//D-H</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_PRIME</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_VALUE</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_BASE</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_NETSCAPE_DB</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="nx">PUB_ALGO</span><span class="p">.</span><span class="nx">DSA</span><span class="o">:</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_PRIME</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">q</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_SUBPRIME</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_BASE</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_VALUE</span><span class="p">);</span>
          <span class="nx">out_fields</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">getAttribute</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">,</span> <span class="nx">CKA_NETSCAPE_DB</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="k">default</span><span class="o">:</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unkown key type algo: &quot;</span> <span class="o">+</span> <span class="nx">keyType</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;generateKeypair: failed: &quot;</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">lineNumber</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pubKey</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">pubKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroyPublicKey</span><span class="p">(</span><span class="nx">pubKey</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">privKey</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">privKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroyPrivateKey</span><span class="p">(</span><span class="nx">privKey</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">slot</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_FreeSlot</span><span class="p">(</span><span class="nx">slot</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dump</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">generateRandomBytes</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">byteCount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;generateRandomBytes() called&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Temporary buffer to hold the generated data.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">let</span> <span class="nx">scratch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="nx">byteCount</span><span class="p">)();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GenerateRandom</span><span class="p">(</span><span class="nx">scratch</span><span class="p">,</span> <span class="nx">byteCount</span><span class="p">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;PK11_GenrateRandom failed&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">encodeBase64</span><span class="p">(</span><span class="nx">scratch</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">scratch</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">encrypt</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aHash</span><span class="p">,</span> <span class="nx">aDerPubKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;encrypt() called&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Step 1. Get rid of the base64 encoding on the inputs.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">let</span> <span class="nx">derPubKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aDerPubKey</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">aHash</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">slot</span><span class="p">,</span> <span class="nx">pubKeyInfo</span><span class="p">,</span> <span class="nx">pubKey</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">slot</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GetInternalSlot</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t get internal slot&quot;</span><span class="p">);</span>

      <span class="nx">pubKeyInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DecodeDERSubjectPublicKeyInfo</span><span class="p">(</span><span class="nx">derPubKey</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pubKeyInfo</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;SECKEY_DecodeDERSubjectPublicKeyInfo failed&quot;</span><span class="p">);</span>

      <span class="nx">pubKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_ExtractPublicKey</span><span class="p">(</span><span class="nx">pubKeyInfo</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pubKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;SECKEY_ExtractPublicKey failed&quot;</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">byteLen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_PublicKeyStrengthInBits</span><span class="p">(</span><span class="nx">pubKey</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> 
      
      <span class="kd">let</span> <span class="nx">inputData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">length</span><span class="p">)();</span> 
      <span class="k">this</span><span class="p">.</span><span class="nx">byteCompress</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="nx">inputData</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">outputData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="nx">byteLen</span><span class="p">)();</span> 

      <span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PubEncryptPKCS1</span><span class="p">(</span><span class="nx">pubKey</span><span class="p">,</span> <span class="nx">outputData</span><span class="p">,</span> <span class="nx">inputData</span><span class="p">,</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> 

      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;PK11_PubEncryptPKCS1 failed&quot;</span><span class="p">);</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">encodeBase64</span><span class="p">(</span><span class="nx">outputData</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">outputData</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;encrypt: failed: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pubKey</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">pubKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroyPublicKey</span><span class="p">(</span><span class="nx">pubKey</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pubKeyInfo</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">pubKeyInfo</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroySubjectPublicKeyInfo</span><span class="p">(</span><span class="nx">pubKeyInfo</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">slot</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_FreeSlot</span><span class="p">(</span><span class="nx">slot</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">decrypt</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aHash</span><span class="p">,</span> <span class="nx">aDerPrivKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;decrypt() called&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Step 1. Get rid of the base64 encoding on the inputs.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">let</span> <span class="nx">derPrivKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeSECItem</span><span class="p">(</span><span class="nx">aDerPrivKey</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">slot</span><span class="p">,</span> <span class="nx">privKey</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>

      <span class="nx">slot</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_GetInternalSlot</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t get internal slot&quot;</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">privKey</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECKEYPrivateKey</span><span class="p">.</span><span class="nx">ptr</span><span class="p">();</span>

      <span class="kd">var</span> <span class="nx">rv</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_ImportDERPrivateKeyInfoAndReturnKey</span><span class="p">(</span><span class="nx">slot</span><span class="p">,</span> <span class="nx">derPrivKey</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span>
                                                                 <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> 
                                                                 <span class="p">(</span><span class="mh">0x7fffffff</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">privKey</span><span class="p">.</span><span class="nx">address</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">privKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Import DER private key failed&quot;</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">aHash</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">byteLen</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

      <span class="kd">let</span> <span class="nx">inputData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="nx">byteLen</span><span class="p">)();</span> <span class="k">this</span><span class="p">.</span><span class="nx">byteCompress</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">inputData</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">outputData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="nx">byteLen</span><span class="p">)();</span> 
      <span class="kd">let</span> <span class="nx">outputLen</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned</span><span class="p">;</span>

      <span class="nx">rv</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_PrivDecryptPKCS1</span><span class="p">(</span><span class="nx">privKey</span><span class="p">,</span> <span class="nx">outputData</span><span class="p">,</span> 
                                          <span class="nx">outputLen</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">byteLen</span><span class="p">,</span> 
                                          <span class="nx">inputData</span><span class="p">,</span> <span class="nx">byteLen</span><span class="p">);</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">encodeBase64</span><span class="p">(</span><span class="nx">outputData</span><span class="p">.</span><span class="nx">address</span><span class="p">(),</span> <span class="nx">outputData</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;decrypt: failed: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">privKey</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">privKey</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SECKEY_DestroyPrivateKey</span><span class="p">(</span><span class="nx">privKey</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">slot</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">PK11_FreeSlot</span><span class="p">(</span><span class="nx">slot</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Utility functions</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compress a JS string (2-byte chars) into a normal C string (1-byte chars)
EG, for "ABC",  0x0041, 0x0042, 0x0043 --> 0x41, 0x42, 0x43</p></div></div><div class="code"><div class="wrapper">  <span class="nx">byteCompress</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jsString</span><span class="p">,</span> <span class="nx">charArray</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">intArray</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">cast</span><span class="p">(</span><span class="nx">charArray</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">uint8_t</span><span class="p">.</span><span class="nx">array</span><span class="p">(</span><span class="nx">charArray</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">jsString</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">intArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">jsString</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span> <span class="c1">// convert to bytes</span>
    <span class="p">}</span>

  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Expand a normal C string (1-byte chars) into a JS string (2-byte chars)
EG, for "ABC",  0x41, 0x42, 0x43 --> 0x0041, 0x0042, 0x0043</p></div></div><div class="code"><div class="wrapper">  <span class="nx">byteExpand</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">charArray</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">charArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">intData</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">cast</span><span class="p">(</span><span class="nx">charArray</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">uint8_t</span><span class="p">.</span><span class="nx">array</span><span class="p">(</span><span class="nx">len</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">expanded</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">intData</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

    <span class="k">return</span> <span class="nx">expanded</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">encodeBase64</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Byte-expand the buffer, so we can treat it as a UCS-2 string
consisting of u0000 - u00FF.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">let</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">intData</span> <span class="o">=</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">cast</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">uint8_t</span><span class="p">.</span><span class="nx">array</span><span class="p">(</span><span class="nx">len</span><span class="p">).</span><span class="nx">ptr</span><span class="p">).</span><span class="nx">contents</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">expanded</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">intData</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

    <span class="k">return</span> <span class="nx">btoa</span><span class="p">(</span><span class="nx">expanded</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">makeSECItem</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">isEncoded</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isEncoded</span><span class="p">)</span>
      <span class="nx">input</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">outputData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctypes</span><span class="p">.</span><span class="nx">ArrayType</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">unsigned_char</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="p">)();</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">byteCompress</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">outputData</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">nss_t</span><span class="p">.</span><span class="nx">SECItem</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nss</span><span class="p">.</span><span class="nx">SIBUFFER</span><span class="p">,</span> <span class="nx">outputData</span><span class="p">,</span> <span class="nx">outputData</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">};</span></div></div></div></div></body></html>