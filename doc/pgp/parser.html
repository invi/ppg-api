<!DOCTYPE html><html lang="en"><head><title>pgp/parser</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="pgp/parser"><meta name="groc-project-path" content="lib/pgp/parser.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/pgp/parser.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="kr">const</span> <span class="nx">PGP</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/openpgpdefs&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">misc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/misc&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">string_to_u32</span><span class="p">}</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">photoid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/photoid&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">base64Encode</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;api-utils/base64&quot;</span><span class="p">).</span><span class="nx">encode</span><span class="p">;</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">sprintf</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/sprintf&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">getStr</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/lang&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;util/logger&quot;</span><span class="p">).</span><span class="nx">create</span><span class="p">(</span><span class="s2">&quot;parser.js&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Parser</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">dump_sig_subpkt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;%ssubpkt %d len %d (&quot;</span> <span class="p">,</span>
                       <span class="nx">hashed</span> <span class="o">?</span> <span class="s2">&quot;hashed &quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;too short: buffer is only %u)\n&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIG_CREATED</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;sig created &quot;</span> <span class="o">+</span> <span class="nx">string_to_u32</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIG_EXPIRE</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">string_to_u32</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">))</span>
            <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;sig expires after&quot;</span> <span class="o">+</span> <span class="nx">string_to_u32</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
          <span class="k">else</span>
            <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;sig does not expire&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">EXPORTABLE</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;%sexportable&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;not &quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">TRUST</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;[invalid trust subpacket]&quot;</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;trust signature of depth &quot;</span><span class="o">+</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;, value &quot;</span><span class="o">+</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REGEXP</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">length</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;[invalid regexp subpacket]&quot;</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;regular expression:&quot;</span> <span class="o">+</span> <span class="nx">buffer</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REVOCABLE</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;not &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;revocable&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KEY_EXPIRE</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">string_to_u32</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">))</span>
            <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;key expires after &quot;</span><span class="o">+</span><span class="nx">string_to_u32</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
          <span class="k">else</span>
            <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;key does not expire&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_SYM</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;pref-sym-algos:&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REV_KEY</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;revocation key: &quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;[too short]&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;c=%02x a=%d f=&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
            <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;%02X&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">ISSUER</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;issuer key ID %08X&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">NOTATION</span><span class="o">:</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;notation: &quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;[too short]&quot;</span><span class="p">);</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">s</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">;</span>
          <span class="nx">n1</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">s</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
          <span class="nx">n2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">s</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
          <span class="nx">s</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">n1</span> <span class="o">+</span> <span class="nx">n2</span> <span class="o">!=</span> <span class="nx">length</span><span class="p">)</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;[error]&quot;</span><span class="p">);</span>
          <span class="k">else</span>
          <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>es<em>write</em>sanitized (listfp, s, n1, ")", NULL);
es_putc ('=', listfp);</p>

<p>if (*buffer &amp; 0x80)
 es<em>write</em>sanitized (listfp, s + n1, n2, ")", NULL);
else
 p = "[not human readable]";</p></div></div><div class="code"><div class="wrapper">          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_HASH</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;pref-hash-algos:&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot; %d&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_COMPR</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;pref-zip-algos:&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot; %d&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KS_FLAGS</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;key server preferences:&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot; %02X&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_KS</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;preferred key server: &quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>es<em>write</em>sanitized (listfp, buffer, length, ")", NULL);</p></div></div><div class="code"><div class="wrapper">        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PRIMARY_UID</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;primary user ID&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">POLICY</span><span class="o">:</span>
        <span class="nx">tmp</span>  <span class="o">+=</span> <span class="s2">&quot;policy: &quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>es<em>write</em>sanitized (listfp, buffer, length, ")", NULL);</p></div></div><div class="code"><div class="wrapper">        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KEY_FLAGS</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;key flags:&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot; %02X&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIGNERS_UID</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;signer&#39;s user ID&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REVOC_REASON</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;revocation reason 0x%02x (&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>es<em>write</em>sanitized (listfp, buffer + 1, length - 1, ")", NULL);</p></div></div><div class="code"><div class="wrapper">            <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">ARR</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;Big Brother&#39;s key (ignored): &quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;[too short]&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;c=%02x a=%d f=&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if (length > 2)
 es<em>write</em>hexstring (listfp, buffer+2, length-2, 0, NULL);</p></div></div><div class="code"><div class="wrapper">        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">FEATURES</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;features:&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot; %02X&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIGNATURE</span><span class="o">:</span>
        <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;signature: &quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;[too short]&quot;</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;v%d, class 0x%02X, algo %d, digest algo %d&quot;</span><span class="p">,</span>
                          <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">:</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                          <span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">:</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">&lt;=</span> <span class="mi">110</span><span class="p">)</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;experimental / private subpacket&quot;</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="nx">tmp</span> <span class="o">+=</span> <span class="s2">&quot;?&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
    
  <span class="nx">parse_sig_subpkt2</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sig</span><span class="p">,</span> <span class="nx">reqtype</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span><span class="p">;</span>
    <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">reqtype</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">p</span><span class="p">)</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">unhashed</span><span class="p">,</span> <span class="nx">reqtype</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
  <span class="p">},</span>
  
  <span class="cm">/*</span>
<span class="cm">   * Returns: &gt;= 0 use this offset into buffer</span>
<span class="cm">   *      -1 explicitly reject returning this type</span>
<span class="cm">   *      -2 subpacket too short</span>
<span class="cm">   */</span>
  <span class="nx">parse_one_sig_subpkt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REV_KEY</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIG_CREATED</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIG_EXPIRE</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KEY_EXPIRE</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KEY_FLAGS</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KS_FLAGS</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_SYM</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_HASH</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_COMPR</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">POLICY</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_KS</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">FEATURES</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REGEXP</span><span class="o">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIGNATURE</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">EXPORTABLE</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REVOCABLE</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REVOC_REASON</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">n</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">ISSUER</span><span class="o">:</span>  <span class="cm">/* issuer key ID */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">NOTATION</span><span class="o">:</span>
        <span class="cm">/* minimum length needed, and the subpacket must be well-formed</span>
<span class="cm">           where the name length and value length all fit inside the</span>
<span class="cm">           packet. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">((</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span> <span class="p">((</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">!=</span> <span class="nx">n</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PRIMARY_UID</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">TRUST</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
  <span class="p">},</span>
  
  <span class="nx">parse_sig_subpkt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pktbuf</span><span class="p">,</span> <span class="nx">reqtype</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span>
        <span class="nx">buflen</span><span class="p">,</span>
        <span class="nx">type</span><span class="p">,</span>
        <span class="nx">offset</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">pktbuf</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="nx">buflen</span> <span class="o">=</span> <span class="nx">pktbuf</span><span class="p">.</span><span class="nx">len</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">too_short</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;buffer shorter than subpacket\n&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">buflen</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="cm">/* 4 byte length header.  */</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">buflen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">too_short</span><span class="p">();</span>
  
        <span class="nx">n</span> <span class="o">=</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
        <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">192</span><span class="p">)</span> <span class="cm">/* 4 byte special encoded length header.  */</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">buflen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">too_short</span><span class="p">();</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="p">((</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">+</span> <span class="mi">192</span><span class="p">;</span>
      <span class="p">}</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="nx">buflen</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">too_short</span><span class="p">();</span>
  
      <span class="kd">var</span> <span class="nx">critical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
      <span class="nx">type</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">type</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
        <span class="nx">critical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
        <span class="nx">critical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="nx">reqtype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">TEST_CRITICAL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">critical</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="nx">buflen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">too_short</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if (!can<em>handle</em>critical (buffer + 1, n - 1, type))
{
logger.error(sprintf("subpacket of type %d has " +
                                        "critical bit set\n"), type);
return null;    /* This is an error.  */</p></div></div><div class="code"><div class="wrapper">          <span class="c1">//}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">reqtype</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* List packets.  */</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">hashed</span> <span class="o">=</span> <span class="p">(</span><span class="nx">reqtype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">LIST_HASHED</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dump_sig_subpkt</span> <span class="p">(</span> <span class="nx">hashed</span> <span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">reqtype</span><span class="p">)</span> <span class="cm">/* Found.  */</span>
      <span class="p">{</span>
        <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="nx">buflen</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">too_short</span><span class="p">();</span>
        <span class="nx">offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_one_sig_subpkt</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span> <span class="c1">//XXX n-1</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="o">-</span><span class="mi">2</span><span class="o">:</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;subpacket of type %d too short\n&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">offset</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">reqtype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">TEST_CRITICAL</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>  <span class="cm">/* Used as True to indicate that there is no. */</span>
    <span class="p">}</span>
  
    <span class="cm">/* Critical bit we don&#39;t understand. */</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>  <span class="cm">/* End of packets; not found.  */</span>
  
  <span class="p">},</span>
  <span class="nx">parse_compressed</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">new_ctb</span><span class="p">)</span> <span class="p">{</span>
  
    <span class="cm">/* PKTLEN is here 0, but data follows (this should be the last</span>
<span class="cm">       object in a file or the compress algorithm should know the</span>
<span class="cm">       length).  */</span>
  
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">algorithm</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkttype</span> <span class="o">=</span> <span class="nx">pkttype</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pktlen</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* not used */</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">new_ctb</span> <span class="o">=</span> <span class="nx">new_ctb</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">buf</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read_rest</span><span class="p">();</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:compressed packet: algo=%d\n&quot;</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">algorithm</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse_trust</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
      <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
      <span class="nx">pkt</span><span class="p">.</span><span class="nx">ring_trust</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
      <span class="nx">pkt</span><span class="p">.</span><span class="nx">ring_trust</span><span class="p">.</span><span class="nx">trustval</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">pkt</span><span class="p">.</span><span class="nx">ring_trust</span><span class="p">.</span><span class="nx">sigcache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">pktlen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">c</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
        <span class="cm">/* We require that bit 7 of the sigcache is 0 (easier eof</span>
<span class="cm">                 handling).  */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
          <span class="nx">pkt</span><span class="p">.</span><span class="nx">ring_trust</span><span class="p">.</span><span class="nx">sigcache</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:trust packet: flag=%d sigcache=%d\n&quot;</span><span class="p">,</span>
                      <span class="nx">pkt</span><span class="p">.</span><span class="nx">ring_trust</span><span class="p">.</span><span class="nx">trustval</span><span class="p">,</span>
                      <span class="nx">pkt</span><span class="p">.</span><span class="nx">ring_trust</span><span class="p">.</span><span class="nx">sigcache</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:trust packet: empty\n&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">parse_plaintext</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">new_ctb</span><span class="p">,</span> <span class="nx">partial</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">namelen</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pt</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">partial</span> <span class="o">&amp;&amp;</span> <span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
      <span class="k">throw</span> <span class="p">{</span> 
              <span class="nx">msg</span><span class="o">:</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;packet(%d) too short (%d)\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">),</span>
              <span class="nx">rc</span><span class="o">:</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span>
            <span class="p">};</span>
  
    <span class="nx">mode</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span><span class="p">)</span>
      <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">namelen</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span><span class="p">)</span>
      <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="cm">/* Note that namelen will never exceed 255 bytes. */</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">new_ctb</span> <span class="o">=</span> <span class="nx">new_ctb</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">namelen</span> <span class="o">=</span> <span class="nx">namelen</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">is_partial</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">;</span>
  
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pktlen</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">namelen</span><span class="p">;</span> <span class="nx">pktlen</span><span class="o">--</span><span class="p">,</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">pkt</span><span class="p">.</span><span class="nx">name</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
    <span class="p">}</span>
  
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read32</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span><span class="p">)</span>
      <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">buf</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">atos</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">read_len</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">));</span>
    <span class="nx">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:literal data packet:\n&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;\tmode %c (%X), created %u, name=%s\&quot;&quot;</span><span class="p">,</span>
                    <span class="nx">mode</span> <span class="o">&gt;=</span> <span class="s1">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">mode</span> <span class="o">&lt;</span> <span class="s1">&#39;z&#39;</span> <span class="o">?</span> <span class="nx">mode</span> <span class="o">:</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span>
                    <span class="nx">pkt</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">name</span>
                <span class="p">);</span>
    <span class="k">return</span> <span class="nx">rc</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse_onepass_sig</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">ops</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">version</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span>
      <span class="k">throw</span> <span class="p">{</span> 
              <span class="nx">msg</span><span class="o">:</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;packet(%d) too short\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">),</span>
              <span class="nx">rc</span><span class="o">:</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span>
            <span class="p">}</span>
  
    <span class="nx">version</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
      <span class="k">throw</span> <span class="p">{</span>
              <span class="nx">msg</span><span class="o">:</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;onepass_sig with unknown version %d\n&quot;</span><span class="p">,</span> <span class="nx">version</span><span class="p">),</span>
              <span class="nx">rc</span><span class="o">:</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span>
            <span class="p">}</span>
  
    <span class="nx">ops</span><span class="p">.</span><span class="nx">sig_class</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">ops</span><span class="p">.</span><span class="nx">digest_algo</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">ops</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">ops</span><span class="p">.</span><span class="nx">keyid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">8</span><span class="p">;</span><span class="nx">i</span><span class="p">;</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span>
      <span class="nx">ops</span><span class="p">.</span><span class="nx">keyid</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
  
    <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="nx">ops</span><span class="p">.</span><span class="nx">last</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span>
                  <span class="s2">&quot;:onepass_sig packet: keyid %s\n&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;\tversion %d, sigclass 0x%02x, digest %d, pubkey %d, &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;last=%d\n&quot;</span><span class="p">,</span>
                  <span class="nx">misc</span><span class="p">.</span><span class="nx">stohex</span><span class="p">(</span><span class="nx">ops</span><span class="p">.</span><span class="nx">keyid</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">(),</span>
                  <span class="nx">version</span><span class="p">,</span> <span class="nx">ops</span><span class="p">.</span><span class="nx">sig_class</span><span class="p">,</span>
                  <span class="nx">ops</span><span class="p">.</span><span class="nx">digest_algo</span><span class="p">,</span> <span class="nx">ops</span><span class="p">.</span><span class="nx">pubkey_algo</span><span class="p">,</span> <span class="nx">ops</span><span class="p">.</span><span class="nx">last</span>
                <span class="p">);</span>
  
    <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">rc</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse_encrypted</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">ed</span><span class="p">,</span> <span class="nx">new_ctb</span><span class="p">,</span> <span class="nx">partial</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code> ed = {};
</code></pre></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">orig_pktlen</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
  
    <span class="cm">/* ed-&gt;len is set below.  */</span>
    <span class="nx">ed</span><span class="p">.</span><span class="nx">extralen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Unknown here; only used in build_packet.  */</span>
    <span class="nx">ed</span><span class="p">.</span><span class="nx">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">ed</span><span class="p">.</span><span class="nx">new_ctb</span> <span class="o">=</span> <span class="nx">new_ctb</span><span class="p">;</span>
    <span class="nx">ed</span><span class="p">.</span><span class="nx">is_partial</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">ENCRYPTED_MDC</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">orig_pktlen</span><span class="p">)</span>
        <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;encrypted_mdc packet with unknown version %d&quot;</span><span class="p">,</span> <span class="nx">version</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">ed</span><span class="p">.</span><span class="nx">mdc_method</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//DIGEST_ALGO_SHA1=2</span>
    <span class="p">}</span>
    <span class="k">else</span>
      <span class="nx">ed</span><span class="p">.</span><span class="nx">mdc_method</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="cm">/* A basic sanity check.  We need at least an 8 byte IV plus the 2</span>
<span class="cm">       detection bytes.  Note that we don&#39;t known the algorithm and thus</span>
<span class="cm">       we may only check against the minimum blocksize.  */</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">orig_pktlen</span> <span class="o">&amp;&amp;</span> <span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Actually this is blocksize+2.  */</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) too short\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="cm">/* Store the remaining length of the encrypted data (i.e. without</span>
<span class="cm">       the MDC version number but with the IV etc.).  This value is</span>
<span class="cm">       required during decryption.  */</span>
    <span class="nx">ed</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">orig_pktlen</span><span class="p">)</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:encrypted data packet:\n\tlength: %d&quot;</span><span class="p">,</span> <span class="nx">orig_pktlen</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:encrypted data packet:\n\tlength: unknown&quot;</span><span class="p">);</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">ed</span><span class="p">.</span><span class="nx">mdc_method</span><span class="p">)</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tmdc_method: %d\n&quot;</span><span class="p">,</span> <span class="nx">ed</span><span class="p">.</span><span class="nx">mdc_method</span><span class="p">);</span>
  
  
    <span class="nx">ed</span><span class="p">.</span><span class="nx">buf</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">ed</span><span class="p">);</span>
  
    <span class="k">return</span> <span class="nx">rc</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse_pubkeyenc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">packet</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ndata</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span><span class="s2">&quot;packet(%d) too short\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">k</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">k</span><span class="p">.</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span><span class="s2">&quot;packet(%d) with unknown version %d\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">k</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="nx">k</span><span class="p">.</span><span class="nx">keyid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">8</span><span class="p">;</span><span class="nx">i</span><span class="p">;</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span>
      <span class="nx">k</span><span class="p">.</span><span class="nx">keyid</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
  
    <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="nx">k</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">k</span><span class="p">.</span><span class="nx">throw_keyid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Only used as flag for build_packet.  */</span>
    <span class="nx">k</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:pubkey enc packet: version %d, algo %d, keyid %s&quot;</span><span class="p">,</span>
                  <span class="nx">k</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">k</span><span class="p">.</span><span class="nx">pubkey_algo</span><span class="p">,</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">stohex</span><span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">keyid</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">());</span>
  
    <span class="kd">var</span> <span class="nx">ndata</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">pubkey_get_nenc</span> <span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">pubkey_algo</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ndata</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;\tunsupported algorithm %d\n&quot;</span><span class="p">,</span> <span class="nx">k</span><span class="p">.</span><span class="nx">pubkey_algo</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ndata</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PUBKEY</span><span class="p">.</span><span class="nx">ALGO</span><span class="p">.</span><span class="nx">ECDH</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">NOT_IMPLEMENTED</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>size<em>t n;
rc = read</em>size_body (inp, pktlen, &amp;n, k>data+i);
pktlen -= n;</p></div></div><div class="code"><div class="wrapper">          <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
          <span class="nx">k</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">mpi_read</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">);</span>
          <span class="nx">pktlen</span> <span class="o">-=</span> <span class="nx">k</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">k</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rc</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse_signature</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">sig</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">md5_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">n</span><span class="p">,</span>
        <span class="nx">is_v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span> <span class="nx">ndata</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) too short\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">);</span>
      <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span> <span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="nx">sig</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();;</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
      <span class="nx">is_v4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) Version %d\n signature packet not implemented&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
      <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span> <span class="p">(</span> <span class="nx">pktlen</span> <span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">NOT_IMPLEMENTED</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) with unknown version %d\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
      <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="nx">sig</span><span class="p">.</span><span class="nx">sig_class</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">sig</span><span class="p">.</span><span class="nx">digest_algo</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
  
    <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">exportable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">revocable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">is_v4</span><span class="p">)</span> <span class="cm">/* Read subpackets.  */</span>
    <span class="p">{</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read16</span><span class="p">();</span>
      <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* Length of hashed data. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;signature packet: hashed data too long\n&quot;</span><span class="p">);</span>
        <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
        <span class="nx">inp</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">);</span>
        <span class="nx">pktlen</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read16</span><span class="p">();</span>
      <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* Length of unhashed data.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;signature packet: unhashed data too long\n&quot;</span><span class="p">);</span>
        <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">unhashed</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">unhashed</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
        <span class="nx">inp</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">unhashed</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
        <span class="nx">pktlen</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>  <span class="cm">/* Sanity check.  */</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) too short\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">);</span>
      <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span> <span class="p">(</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="nx">sig</span><span class="p">.</span><span class="nx">digest_start</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">(),</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="p">];</span>
    <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="p">)</span>  <span class="cm">/* Extract required information.  */</span>
    <span class="p">{</span>
  
        <span class="cm">/* Set sig-&gt;flags.unknown_critical if there is a critical bit</span>
<span class="cm">         * set for packets which we do not understand.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">TEST_CRITICAL</span><span class="p">)</span>
          <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">unhashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">TEST_CRITICAL</span><span class="p">))</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">unknown_critical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIG_CREATED</span><span class="p">);</span>
      
  
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">string_to_u32</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">&lt;=</span> <span class="mi">110</span><span class="p">))</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;signature packet without timestamp\n&quot;</span><span class="p">);</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt2</span><span class="p">(</span><span class="nx">sig</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">ISSUER</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">keyid</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">atos</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> 
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">&lt;=</span> <span class="mi">110</span><span class="p">))</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;signature packet without keyid\n&quot;</span><span class="p">);</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KEY_EXPIRE</span><span class="p">);</span> 
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">string_to_u32</span> <span class="p">(</span><span class="nx">p</span><span class="p">))</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">expiredate</span> <span class="o">=</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">+</span> <span class="nx">string_to_u32</span> <span class="p">(</span><span class="nx">p</span><span class="p">);</span>
  
      <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">expired</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">policy_url</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">notations</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="nx">pref_ks</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">revocable</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">key_flags</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">string_to_u32</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">expiredate</span> <span class="o">&gt;=</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">expired</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">policy_url</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_KS</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">pref_ks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">NOTATION</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">notation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REVOCABLE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">revocable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KEY_FLAGS</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">key_flags</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_SYM</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">pref_sym</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REV_KEY</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">rev_key</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_HASH</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">pref_hash</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_COMPR</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">pref_compr</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">KS_FLAGS</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">ks_flags</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PREF_KS</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">pref_flags</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">PRIMARY_UID</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">primary_uid</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">policy</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">SIGNERS_UID</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">signers_uid</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REVOC_REASON</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">revoc_reason</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">revoc_comment</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">atos</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
      <span class="p">}</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">TRUST</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">trust_depth</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">trust_value</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  
        <span class="cm">/* Only look for a regexp if there is also a trust</span>
<span class="cm">           subpacket. */</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">trust_regexp</span> <span class="o">=</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">REGEXP</span><span class="p">);</span>
  
      <span class="p">}</span>
  
        <span class="cm">/* We accept the exportable subpacket from either the hashed or</span>
<span class="cm">           unhashed areas as older versions of gpg put it in the</span>
<span class="cm">           unhashed area.  In theory, anyway, we should never see this</span>
<span class="cm">           packet off of a local keyring. */</span>
  
      <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">EXPORTABLE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">exportable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
        <span class="cm">/* Find all revocation keys.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">sig_class</span> <span class="o">==</span> <span class="mh">0x1F</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parse_revkeys</span> <span class="p">(</span><span class="nx">sig</span><span class="p">);</span>
      
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:signature packet: algo %d, keyid %s\n&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;\tversion %d, created %d, md5len %d, sigclass 0x%02x\n&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;\tdigest algo %d, begin of digest %02x %02x&quot;</span><span class="p">,</span>
                  <span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span><span class="p">,</span>
                  <span class="nx">misc</span><span class="p">.</span><span class="nx">stohex</span><span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">keyid</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">(),</span>
                  <span class="nx">sig</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span> <span class="nx">md5_len</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">sig_class</span><span class="p">,</span>
                  <span class="nx">sig</span><span class="p">.</span><span class="nx">digest_algo</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">digest_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">digest_start</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">is_v4</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">hashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">LIST_HASHED</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parse_sig_subpkt</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">unhashed</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">SIGSUBPKT</span><span class="p">.</span><span class="nx">LIST_UNHASHED</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="nx">ndata</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">pubkey_get_nsig</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span><span class="p">);</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ndata</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;\tunknown algorithm %d\n&quot;</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">pubkey_algo</span><span class="p">);</span>
      <span class="nx">rc</span> <span class="o">=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="nx">sig</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ndata</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">sig</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">mpi_read</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">);</span>
        <span class="nx">pktlen</span> <span class="o">-=</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>mpi<em>print (listfp, sig->data[i], mpi</em>print_mode);</p></div></div><div class="code"><div class="wrapper">  
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sig</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">rc</span> <span class="o">=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span> <span class="p">(</span> <span class="nx">pktlen</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rc</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="cm">/* Find all revocation keys.  Look in hashed area only.  */</span>
  <span class="nx">parse_revkeys</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sig</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">revkey</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">len</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">sig</span><span class="p">.</span><span class="nx">sig_class</span> <span class="o">!=</span> <span class="mh">0x1F</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>while ((revkey =
 (struct revocation<em>key *) enum</em>sig<em>subpkt (sig->hashed,
                     SIGSUBPKT</em>REV<em>KEY,
                     &amp;len, &amp;seq, NULL)))
 {
   if (len == sizeof (struct revocation</em>key)
       &amp;&amp; (revkey->class &amp; 0x80))  /* 0x80 bit must be set.  */
{
 sig->revkey = xrealloc (sig->revkey,
          sizeof (struct revocation_key *) *
          (sig->numrevkeys + 1));
 sig->revkey[sig->numrevkeys] = revkey;
 sig->numrevkeys++;</p></div></div><div class="code"><div class="wrapper">    <span class="c1">//}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>}</p></div></div><div class="code"><div class="wrapper">  <span class="p">},</span>
  <span class="nx">parse_user_id</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) too large\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">);</span>
      <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span> <span class="p">(</span> <span class="nx">pktlen</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INVALID_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">pktlen</span><span class="p">;</span> <span class="nx">pktlen</span><span class="o">--</span><span class="p">)</span>
      <span class="nx">p</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
  
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:user ID packet: \&quot;%s\&quot;&quot;</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="cm">/* Attribute subpackets have the same format as v4 signature</span>
<span class="cm">     subpackets.  This is not part of OpenPGP, but is done in several</span>
<span class="cm">     versions of PGP nevertheless.  */</span>
  <span class="nx">parse_attribute_subpkts</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">attrib_data</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">buflen</span> <span class="o">=</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">attrib_len</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">attribs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">type</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">buflen</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span>
        <span class="nx">buflen</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>  <span class="cm">/* 4 byte length header.  */</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">buflen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;TOO_SHORT&quot;</span><span class="p">);</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
          <span class="nx">buflen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">192</span><span class="p">)</span>  <span class="cm">/* 2 byte special encoded length header.  */</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">buflen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;TOO_SHORT&quot;</span><span class="p">);</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="p">((</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">+</span> <span class="mi">192</span><span class="p">;</span>
          <span class="nx">buflen</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">buflen</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span>
          <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;TOO_SHORT&quot;</span><span class="p">);</span>
  
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span>
        <span class="nx">buflen</span><span class="o">--</span><span class="p">;</span>
        <span class="nx">n</span><span class="o">--</span><span class="p">;</span>
  
        <span class="nx">attribs</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
        <span class="nx">attribs</span><span class="p">[</span><span class="nx">count</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="nx">attribs</span><span class="p">[</span><span class="nx">count</span><span class="p">].</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">i</span><span class="o">+</span><span class="nx">n</span><span class="p">);</span>
        <span class="nx">attribs</span><span class="p">[</span><span class="nx">count</span><span class="p">].</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
        <span class="nx">buflen</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;</span>
        <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span> <span class="o">=</span> <span class="nx">attribs</span><span class="p">;</span>
      <span class="nx">uid</span><span class="p">.</span><span class="nx">numattribs</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;buffer shorter than attribute subpacket\n&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">make_attribute_uidname</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="nx">max_namelen</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>assert (max_namelen > 70);</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">uid</span><span class="p">.</span><span class="nx">numattribs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nx">uid</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;[bad attribute packet of size %u]&quot;</span><span class="p">,</span> 
                                  <span class="nx">uid</span><span class="p">.</span><span class="nx">attrib_len</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">uid</span><span class="p">.</span><span class="nx">numattribs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nx">uid</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;[%d attributes of size %u]&quot;</span><span class="p">,</span> 
                                  <span class="nx">uid</span><span class="p">.</span><span class="nx">numattribs</span><span class="p">,</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">attrib_len</span><span class="p">);</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/* Only one attribute, so list it as the &quot;user id&quot; */</span>
      <span class="kr">const</span> <span class="nx">ATTRIB_IMAGE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">ATTRIB_IMAGE</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">len</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">photoid</span><span class="p">.</span><span class="nx">parse_image_header</span><span class="p">(</span><span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">image</span> <span class="o">=</span> <span class="nx">base64Encode</span><span class="p">(</span><span class="nx">misc</span><span class="p">.</span><span class="nx">atos</span><span class="p">(</span><span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">16</span><span class="p">)));</span>
          <span class="nx">uid</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;image_size&quot;</span><span class="p">,</span> 
                       <span class="nx">photoid</span><span class="p">.</span><span class="nx">image_type_to_string</span> <span class="p">(</span><span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">type</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">len</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
          <span class="nx">uid</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;invalid_image&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">uid</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;unknown_attrib&quot;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">len</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">parse_attribute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">attrib_len</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
  
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">[];</span>
  
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">pktlen</span><span class="p">;</span> <span class="nx">pktlen</span><span class="o">--</span><span class="p">)</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
  
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">attrib_data</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
  
    <span class="cm">/* Now parse out the individual attribute subpackets.  This is</span>
<span class="cm">       somewhat pointless since there is only one currently defined</span>
<span class="cm">       attribute type (jpeg), but it is correct by the spec. */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parse_attribute_subpkts</span> <span class="p">(</span><span class="nx">pkt</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">EXTRA_UID_NAME_SPACE</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">make_attribute_uidname</span> <span class="p">(</span><span class="nx">pkt</span><span class="p">,</span> <span class="nx">EXTRA_UID_NAME_SPACE</span><span class="p">);</span>
  
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span> <span class="s2">&quot;:attribute packet: &quot;</span> <span class="o">+</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse_key</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">algorithm</span><span class="p">,</span>
        <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">expiredate</span><span class="p">,</span> <span class="nx">max_expiredate</span><span class="p">,</span>
        <span class="nx">npkey</span><span class="p">,</span> <span class="nx">nskey</span><span class="p">,</span>
        <span class="nx">is_v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="kd">var</span> <span class="nx">pktlen</span> <span class="o">=</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">pktlen</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pkttype</span> <span class="o">=</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkttype</span><span class="p">;</span>
  
    <span class="nx">version</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span> 
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PUBLIC_SUBKEY</span> <span class="o">&amp;&amp;</span> <span class="nx">version</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Early versions of G10 used the old PGP comments packets;</span>
<span class="cm">       * luckily all those comments are started by a hash.  */</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:rfc1991 comment packet: \&quot;&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">cbuf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">pktlen</span><span class="p">;</span> <span class="nx">pktlen</span><span class="o">--</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">c</span><span class="p">;</span>
        <span class="nx">c</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
  
        <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&gt;=</span> <span class="s1">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;=</span> <span class="s1">&#39;z&#39;</span><span class="p">)</span>
          <span class="nx">cbuf</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="nx">cbuf</span> <span class="o">+=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
  
      <span class="p">}</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">cbuf</span><span class="p">);</span>
      <span class="nx">inp</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
      <span class="nx">is_v4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">version</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) with unknown version %d\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">version</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;packet(%d) too short\n&quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read32</span><span class="p">();</span>
    <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">is_v4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">expiredate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* have to get it from the selfsignature */</span>
      <span class="nx">max_expiredate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="nx">ndays</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read16</span><span class="p">();</span>
      <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ndays</span><span class="p">)</span>
        <span class="nx">expiredate</span> <span class="o">=</span> <span class="nx">timestamp</span> <span class="o">+</span> <span class="nx">ndays</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="nx">expiredate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
      <span class="nx">max_expiredate</span> <span class="o">=</span> <span class="nx">expiredate</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">algorithm</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;:%s key packet:\n&quot;</span> <span class="o">+</span> 
                 <span class="s2">&quot;\tversion %d, algo %d,\n\tcreated %s,\n\texpires %s&quot;</span><span class="p">,</span>
                 <span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PUBLIC_KEY</span> <span class="o">?</span> <span class="s2">&quot;public&quot;</span> <span class="o">:</span>
                 <span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SECRET_KEY</span> <span class="o">?</span> <span class="s2">&quot;secret&quot;</span> <span class="o">:</span>
                 <span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PUBLIC_SUBKEY</span> <span class="o">?</span> <span class="s2">&quot;public sub&quot;</span> <span class="o">:</span>
                 <span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SECRET_SUBKEY</span> <span class="o">?</span> <span class="s2">&quot;secret sub&quot;</span> <span class="o">:</span> <span class="s2">&quot;??&quot;</span><span class="p">,</span>
                 <span class="nx">version</span><span class="p">,</span> <span class="nx">algorithm</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">expiredate</span><span class="p">);</span>
  
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">expiredate</span> <span class="o">=</span> <span class="nx">expiredate</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">max_expiredate</span> <span class="o">=</span> <span class="nx">max_expiredate</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">version</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">flags</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">primary</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PUBLIC_KEY</span> <span class="o">||</span> <span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pubkey_algo</span> <span class="o">=</span> <span class="nx">algorithm</span><span class="p">;</span>
  
    <span class="nx">nskey</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">pubkey_get_nskey</span> <span class="p">(</span><span class="nx">algorithm</span><span class="p">);</span>
    <span class="nx">npkey</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">pubkey_get_npkey</span> <span class="p">(</span><span class="nx">algorithm</span><span class="p">);</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">npkey</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;\tunknown algorithm %d\n&quot;</span><span class="p">,</span> <span class="nx">algorithm</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkey</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">npkey</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkey</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">mpi_read</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">);</span> 
      
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pkey</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> 
        <span class="p">{</span>
          <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
        <span class="p">}</span>
  
        <span class="nx">pktlen</span> <span class="o">-=</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkey</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="kd">var</span> <span class="nx">ski</span> <span class="o">=</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">ski</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">usage</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">mode</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="nx">ski</span><span class="p">.</span><span class="nx">is_protected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SECRET_KEY</span> <span class="o">||</span> <span class="nx">pkttype</span> <span class="o">==</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SECRET_SUBKEY</span><span class="p">)</span>
    <span class="p">{</span>  
      <span class="nx">pkt</span><span class="p">.</span><span class="nx">skey</span> <span class="o">=</span> <span class="p">[];</span>
  
      <span class="nx">ski</span><span class="p">.</span><span class="nx">usage</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
      <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">usage</span><span class="p">)</span> 
      <span class="p">{</span>
        <span class="nx">ski</span><span class="p">.</span><span class="nx">is_protected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">usage</span> <span class="o">==</span> <span class="mi">254</span> <span class="o">||</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">usage</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> 
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> 
          <span class="p">{</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
          <span class="p">}</span>
  
          <span class="nx">ski</span><span class="p">.</span><span class="nx">sha1chk</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">usage</span> <span class="o">==</span> <span class="mi">254</span><span class="p">);</span>
          <span class="nx">ski</span><span class="p">.</span><span class="nx">algo</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
          <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
  
          <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
          <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
          <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">hash_algo</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
          <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
  
          <span class="k">switch</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
              <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
              <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="nx">pktlen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">pktlen</span><span class="o">--</span><span class="p">)</span>
                <span class="nx">temp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
              <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">salt</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
  
          <span class="cm">/* check the mode.  */</span>
          <span class="k">switch</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tsimple S2K&quot;</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tsalted S2K&quot;</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\titer+salt S2K&quot;</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">1001</span><span class="o">:</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tgnu-dummy S2K&quot;</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">1002</span><span class="o">:</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tgnu-divert-to-card S2K&quot;</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tunknown %sS2K %d\n&quot;</span><span class="p">,</span>
                                        <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;GNU &quot;</span><span class="p">,</span>
                                        <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span><span class="p">);</span>
  
              <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;, algo: %d,%s hash: %d&quot;</span><span class="p">,</span>
                      <span class="nx">ski</span><span class="p">.</span><span class="nx">algo</span><span class="p">,</span>
                      <span class="nx">ski</span><span class="p">.</span><span class="nx">sha1chk</span> <span class="o">?</span> <span class="s2">&quot; SHA1 protection,&quot;</span>
                                  <span class="o">:</span> <span class="s2">&quot; simple checksum,&quot;</span><span class="p">,</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">hash_algo</span><span class="p">);</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;, salt: &quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* Read remaining protection parameters.  */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
          <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tprotect count: %d (%d)\n&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>S2K<em>DECODE</em>COUNT ((ulong)ski->s2k.count),</p></div></div><div class="code"><div class="wrapper">                                    <span class="mi">0</span><span class="p">,</span>
                                    <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">1002</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* Read the serial number. */</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">snlen</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
          <span class="nx">pktlen</span><span class="o">--</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="nx">snlen</span> <span class="o">||</span> <span class="nx">snlen</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">return</span> <span class="nx">PGP_ERR_INV_PACKET</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="cm">/* Old version; no S2K, so we set mode to 0, hash MD5.  */</span>
        <span class="p">{</span>
          <span class="cm">/* Note that a ski-&gt;algo &gt; 110 is illegal, but I&#39;m not</span>
<span class="cm">             erroring on it here as otherwise there would be no</span>
<span class="cm">             way to delete such a key.  */</span>
          <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">hash_algo</span> <span class="o">=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">DIGEST_ALGO_MD5</span><span class="p">;</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;protect algo: %d  (hash algo: %d)&quot;</span><span class="p">,</span>
                              <span class="nx">ski</span><span class="p">.</span><span class="nx">algo</span><span class="p">,</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">hash_algo</span><span class="p">);</span>
        <span class="p">}</span>
    
        <span class="cm">/* It is really ugly that we don&#39;t know the size</span>
<span class="cm">         * of the IV here in cases we are not aware of the algorithm.</span>
<span class="cm">         * so a</span>
<span class="cm">         *   ski-&gt;ivlen = cipher_get_blocksize (ski-&gt;algo);</span>
<span class="cm">         * won&#39;t work.  The only solution I see is to hardwire it.</span>
<span class="cm">         * NOTE: if you change the ivlen above 16, don&#39;t forget to</span>
<span class="cm">         * enlarge temp.  */</span>
        <span class="nx">ski</span><span class="p">.</span><span class="nx">ivlen</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">openpgp_cipher_blocklen</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">algo</span><span class="p">);</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">1001</span><span class="p">)</span>
          <span class="nx">ski</span><span class="p">.</span><span class="nx">ivlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">1002</span><span class="p">)</span>
          <span class="nx">ski</span><span class="p">.</span><span class="nx">ivlen</span> <span class="o">=</span> <span class="nx">snlen</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">?</span> <span class="nx">snlen</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="nx">pktlen</span> <span class="o">&lt;</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">ivlen</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
        <span class="p">}</span>
    
        <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">ivlen</span> <span class="o">&amp;&amp;</span> <span class="nx">pktlen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">pktlen</span><span class="o">--</span><span class="p">)</span>
          <span class="nx">temp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
    
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">1002</span> <span class="o">?</span> <span class="s2">&quot;\tserial-number: &quot;</span>
                                           <span class="o">:</span> <span class="s2">&quot;\tprotect IV: &quot;</span> <span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">ivlen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot; %02x&quot;</span><span class="p">,</span> <span class="nx">temp</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">ski</span><span class="p">.</span><span class="nx">iv</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="cm">/* It does not make sense to read it into secure memory.</span>
<span class="cm">     * If the user is so careless, not to protect his secret key,</span>
<span class="cm">     * we can assume, that he operates an open system :=(.</span>
<span class="cm">     * So we put the key into secure memory when we unprotect it. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">1001</span> <span class="o">||</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">s2k</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="mi">1002</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/* Better set some dummy stuff here.  */</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pk->pkey[npkey] = gcry<em>mpi</em>set_opaque (NULL,
                     xstrdup ("dummydata"),
                     10 * 8);</p></div></div><div class="code"><div class="wrapper">        <span class="nx">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">is_v4</span> <span class="o">&amp;&amp;</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">is_protected</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/* Ugly: The length is encrypted too, so we read all stuff</span>
<span class="cm">         * up to the end of the packet into the first SKEY</span>
<span class="cm">         * element.  */</span>
    
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
        <span class="nx">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tskey[%d]: [v4 protected]\n&quot;</span><span class="p">,</span> <span class="nx">npkey</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="cm">/* The v3 method: The mpi length is not encrypted.  */</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nskey</span> <span class="o">-</span> <span class="nx">npkey</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">ski</span><span class="p">.</span><span class="nx">is_protected</span><span class="p">)</span>
          <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pk->pkey[i] = read<em>protected</em>v3<em>mpi (inp, &amp;pktlen);
if (list</em>mode)</p></div></div><div class="code"><div class="wrapper">            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span> <span class="s2">&quot;\tskey[%d]: [v3 protected]\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
            <span class="nx">pkt</span><span class="p">.</span><span class="nx">skey</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">misc</span><span class="p">.</span><span class="nx">mpi_read</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">);</span>
            <span class="nx">pktlen</span> <span class="o">-=</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">skey</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tskey[%d]: (%d bits)&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">skey</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
          <span class="p">}</span>
    
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">skey</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
        <span class="p">}</span>
    
        <span class="nx">ski</span><span class="p">.</span><span class="nx">csum</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read16</span><span class="p">();</span>
        <span class="nx">pktlen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;\tchecksum: %x&quot;</span><span class="p">,</span> <span class="nx">ski</span><span class="p">.</span><span class="nx">csum</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span>
  
  <span class="cm">/*</span>
<span class="cm">   * Parse packet. </span>
<span class="cm">   */</span>
  <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
        <span class="nx">partial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">pkttype</span><span class="p">,</span>
        <span class="nx">ctb</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">((</span><span class="nx">ctb</span> <span class="o">=</span> <span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">()))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">ctb</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;: invalid packet (ctb=%02x)&quot;</span><span class="p">,</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">where</span><span class="p">());</span>
      <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="kd">var</span> <span class="nx">new_ctb</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="nx">ctb</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="nx">new_ctb</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">pkttype</span> <span class="o">=</span> <span class="nx">ctb</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">c</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span><span class="s2">&quot;%s: 1st length byte missing&quot;</span><span class="p">,</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">where</span><span class="p">());</span>
        <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="mi">192</span><span class="p">)</span>
        <span class="nx">pktlen</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="mi">224</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">pktlen</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span><span class="s2">&quot;%s: 2nd length byte missing&quot;</span><span class="p">,</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">where</span><span class="p">());</span>
          <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">pktlen</span> <span class="o">+=</span> <span class="nx">c</span> <span class="o">+</span> <span class="mi">192</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">pktlen</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
        <span class="nx">pktlen</span> <span class="o">|=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
        <span class="nx">pktlen</span> <span class="o">|=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;%s: 4 byte length invalid&quot;</span><span class="p">,</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">where</span><span class="p">());</span>
          <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="cm">/* Partial body length.  */</span>
      <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">pkttype</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="nx">PKT_PLAINTEXT</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">PKT_ENCRYPTED</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">PKT_ENCRYPTED_MDC</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">PKT_COMPRESSED</span><span class="o">:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>iobuf<em>set</em>partial<em>block</em>mode (inp, c &amp; 0xff);</p></div></div><div class="code"><div class="wrapper">          <span class="nx">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* To indicate partial length.  */</span>
          <span class="nx">partial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
  
        <span class="k">default</span><span class="o">:</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;%s: partial length for invalid&quot;</span> <span class="o">+</span>
                     <span class="s2">&quot; packet type %d&quot;</span><span class="p">,</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">where</span><span class="p">(),</span> <span class="nx">pkttype</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">INV_PACKET</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="nx">pkttype</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ctb</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">lenbytes</span> <span class="o">=</span> <span class="p">((</span><span class="nx">ctb</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nx">ctb</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lenbytes</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">partial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pkttype</span> <span class="o">!=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">ENCRYPTED</span> <span class="o">&amp;&amp;</span> <span class="nx">pkttype</span> <span class="o">!=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PLAINTEXT</span>
            <span class="o">&amp;&amp;</span> <span class="nx">pkttype</span> <span class="o">!=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">COMPRESSED</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;%s: indeterminate length for invalid&quot;</span> <span class="o">+</span>
                       <span class="s2">&quot; packet type %d\n&quot;</span><span class="p">,</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">where</span><span class="p">(),</span> <span class="nx">pkttype</span><span class="p">);</span>
          <span class="k">throw</span> <span class="s2">&quot;PGP.ERR.INV_PACKET&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="nx">lenbytes</span><span class="p">;</span> <span class="nx">lenbytes</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">pktlen</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
          <span class="nx">pktlen</span> <span class="o">|=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;parse_packet(iob=%s): type=%d length=%d%s&quot;</span><span class="p">,</span>
                 <span class="nx">inp</span><span class="p">.</span><span class="nx">where</span><span class="p">()</span> <span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">new_ctb</span> <span class="o">?</span> <span class="s2">&quot; (new_ctb)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
  
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pktlen</span> <span class="o">=</span> <span class="nx">pktlen</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkttype</span> <span class="o">=</span> <span class="nx">pkttype</span><span class="p">;</span>
  
    <span class="nx">rc</span> <span class="o">=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ERR</span><span class="p">.</span><span class="nx">UNKNOWN_PACKET</span><span class="p">;</span>  <span class="cm">/* default error */</span>
  
    <span class="k">switch</span> <span class="p">(</span><span class="nx">pkttype</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PUBLIC_KEY</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PUBLIC_SUBKEY</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SECRET_SUBKEY</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_key</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>case PKT<em>SYMKEY</em>ENC:
  rc = parse_symkeyenc (inp, pkttype, pktlen, pkt);
  break;</p></div></div><div class="code"><div class="wrapper">      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PUBKEY_ENC</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_pubkeyenc</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">SIGNATURE</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_signature</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">ONEPASS_SIG</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_onepass_sig</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">USER_ID</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_user_id</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">ATTRIBUTE</span><span class="o">:</span>
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkttype</span> <span class="o">=</span> <span class="nx">pkttype</span> <span class="o">=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">USER_ID</span><span class="p">;</span>  <span class="cm">/* we store it in the userID */</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_attribute</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>case PKT<em>OLD</em>COMMENT:
   case PKT<em>COMMENT:
     rc = parse</em>comment (inp, pkttype, pktlen, pkt);
     break;</p></div></div><div class="code"><div class="wrapper">      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">RING_TRUST</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parse_trust</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">);</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">PLAINTEXT</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_plaintext</span><span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">new_ctb</span><span class="p">,</span> <span class="nx">partial</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">COMPRESSED</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_compressed</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">new_ctb</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">ENCRYPTED</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">ENCRYPTED_MDC</span><span class="o">:</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse_encrypted</span> <span class="p">(</span><span class="nx">inp</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">new_ctb</span><span class="p">,</span> <span class="nx">partial</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">MDC</span><span class="o">:</span>
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">pkttype</span> <span class="o">=</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">PKT</span><span class="p">.</span><span class="nx">MDC</span><span class="p">;</span>
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">inp</span><span class="p">.</span><span class="nx">read_len</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
        <span class="nx">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rc = parse<em>mdc (inp, pkttype, pktlen, pkt, new</em>ctb);</p></div></div><div class="code"><div class="wrapper">        <span class="k">break</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>case PKT<em>PGP</em>CONTROL:
     rc = parse<em>gpg</em>control (inp, pkttype, pktlen, pkt, partial);
     break;
   case PKT<em>MARKER:
     rc = parse</em>marker (inp, pkttype, pktlen);
     break;</p></div></div><div class="code"><div class="wrapper">      <span class="k">default</span><span class="o">:</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Unknown packet (type=%d): skipping %d bytes &quot;</span><span class="p">,</span> <span class="nx">pkttype</span><span class="p">,</span> <span class="nx">pktlen</span><span class="p">);</span>
        <span class="nx">inp</span><span class="p">.</span><span class="nx">skip_rest</span><span class="p">(</span><span class="nx">pktlen</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rc</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Parser</span> <span class="o">=</span> <span class="nx">Parser</span><span class="p">;</span></div></div></div></div></body></html>